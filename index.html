<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>agraj - Portfolio</title>
    <link rel="icon" type="image/png" href="logo.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhai+2:wght@700&family=Inter:wght@400;500;600;700&family=Lato:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;500;700&family=Nunito:wght@400;700&family=Fuzzy+Bubbles:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

    <script>
        // Tailwind config from your previous correct version
        window.tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-purple': '#9272CE', 'brand-purple-light': '#AE8BD5', 'brand-purple-lighter': '#CBB8E8',
                        'text-on-black-primary': '#EAEAEA', 'text-on-black-secondary': '#B0B0B0', 'text-on-black-tertiary': '#888888',
                        'nav-text-dark': '#222222', 'nav-text-dark-subtle': '#555555', 'nav-bg-light-grey': '#E9E9E9', 'nav-quote-bg-on-light': '#DDDDDD',
                        'article-bg': 'rgba(20, 20, 22, 0.93)', 'writings-card-bg': 'rgba(25, 15, 40, 0.88)', 'writings-card-hover-bg': 'rgba(45, 35, 60, 0.96)',
                        'correct-answer-bg': 'rgba(146, 114, 206, 0.35)', 'selected-wrong-bg': 'rgba(100, 100, 100, 0.3)', 'disabled-option-bg': 'rgba(30, 20, 50, 0.7)',
                    },
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'], serif: ['Baloo Bhai 2', 'cursive'],
                        lato: ['Lato', 'sans-serif'], outfit: ['Outfit', 'sans-serif'],
                        nunito: ['Nunito', 'sans-serif'], 'fuzzy-bubbles': ['Fuzzy Bubbles', 'cursive'],
                    },
                }
            }
        };
    </script>

    <style>
        :root {
            --page-bg: #000000; --text-main: var(--text-on-black-primary, #EAEAEA); --text-subtle: var(--text-on-black-secondary, #B0B0B0);
            --highlight-purple: #9272CE; --highlight-purple-hover: #AE8BD5; --highlight-purple-lighter: #CBB8E8;
            --nav-bg: var(--nav-bg-light-grey, #E9E9E9); --nav-text: var(--nav-text-dark, #222222); --nav-text-subtle: var(--nav-text-dark-subtle, #555555);
            --nav-quote-bg: var(--nav-quote-bg-on-light, #DDDDDD); --nav-link-hover-bg: rgba(146, 114, 206, 0.1); 
            --p5-blob-hue-min: 230; --p5-blob-hue-max: 310; --p5-blob-opacity: 4; 
            --bg-overlay-color-1: rgba(146, 114, 206, 0.02); --bg-overlay-color-2: rgba(0, 0, 0, 0.85); 
            --article-bg-color: rgba(20, 20, 22, 0.93); --writings-card-bg-color: rgba(25, 15, 40, 0.88);
            --writings-card-hover-bg-color: rgba(45, 35, 60, 0.96); --card-border-color: rgba(146, 114, 206, 0.25);
            --card-hover-border-color: rgba(146, 114, 206, 0.45);
        }
        html { scroll-behavior: smooth; }
        body { background-color: var(--page-bg); color: var(--text-main); font-family: 'Inter', sans-serif; overflow-x: hidden; line-height: 1.6; font-size: 16px; }
        #p5-background-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; }
        .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 30%, var(--bg-overlay-color-1), var(--bg-overlay-color-2) 70%); z-index: -5; pointer-events:none; }
        .site-container { display: flex; min-height: 100vh; }
        .site-navbar { width: 38.2vw; min-width: 300px; max-width: 550px; background-color: var(--nav-bg); border-right: 1px solid #CCCCCC; position: fixed; top: 0; left: 0; height: 100vh; padding: 2.5rem calc(2.5rem / 1.618); display: flex; flex-direction: column; justify-content: space-between; overflow-y: auto; z-index: 100; }
        .navbar-top-content { text-align: center; }
        #navbar-agraj-image { width: 70%; max-width: 220px; height: auto; margin: 0 auto 1rem; display: block; }
        
        .site-navbar #typewriter { /* This is the tagline */
            min-height: 2.5em; /* Kept relatively small for a tagline */
            font-size: 0.95rem;   
            color: var(--nav-text-subtle);
            margin-bottom: 1rem; 
            padding: 0.3rem; /* Minimal padding for tagline */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center; /* Center align tagline */
            width: 95%; 
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
            /* No explicit background for tagline, let it sit on navbar bg */
        }
        .site-navbar #main-heading-text { min-height: 1.2em; display: inline-block; }
        .site-navbar #blockquote-text { min-height: 3em; display: inline-block; font-size: 0.9rem; width: 100%; box-sizing: border-box; }
        .site-navbar .typed-cursor { background-color: var(--highlight-purple); }
        
        .site-navbar .quote { /* This is for the longer quotes */
            position: relative; border-left: 3px solid var(--highlight-purple);
            margin-top: 0; margin-bottom: 2.5rem; 
            background-color: var(--nav-quote-bg); 
            padding: 1.5rem 1.5rem; /* Increased padding */
            border-radius: 0.5rem; /* Slightly larger radius */
            font-size: 1rem; /* Increased font size */
            color: var(--nav-text-subtle);
            min-height: 8em; /* Significantly increased height */
            width: 98%; /* Increased width */
            max-width: 450px; /* Max width for very wide navbars */
            margin-left: auto; margin-right: auto;
            display: flex; align-items: center; justify-content: flex-start;
            text-align: left; 
            box-sizing: border-box;
            overflow-y: auto; /* Allow scroll if quote is very long */
        }
        .site-navbar .quote::before { content: '"'; position: absolute; top: 0.2em; left: 0.3em; font-size: 3.5em; color: color-mix(in srgb, var(--nav-text-subtle) 15%, transparent); font-family: 'Inter', sans-serif; font-weight: 700; line-height: 1; }
        
        .navbar-links a { display: block; padding: 0.85rem calc(0.85rem * 1.618); margin-bottom: 0.5rem; text-decoration: none; color: var(--nav-text); font-weight: 500; border-radius: 0.375rem; transition: background-color 0.2s ease, color 0.2s ease; font-size: 1.1rem; }
        .navbar-links a:hover { background-color: var(--nav-link-hover-bg); color: var(--highlight-purple); }
        .navbar-links a.active { background-color: var(--highlight-purple); color: white !important; font-weight: 700; }
        .navbar-links a[target="_blank"]::after { content: ' \2197'; font-size: 0.7em; vertical-align: super; display: inline-block; margin-left: 2px; opacity: 0.7; }
        .navbar-bottom { text-align: center; margin-top:1rem; }
        #navbar-logo-image { width: 60px; height: auto; margin: 1.5rem auto 0; cursor: pointer; display: block; opacity: 0.8; transition: opacity 0.2s ease; }
        #navbar-logo-image:hover { opacity: 1; }
        
        .site-content { margin-left: 38.2vw; width: calc(100% - 38.2vw); padding: 2rem; background-color: var(--page-bg); overflow-x: hidden; position: relative; }
        @media (max-width: calc(300px / 0.382)) { .site-content { margin-left: 300px; width: calc(100% - 300px); } }
        @media (min-width: calc(550px / 0.382)) { .site-content { margin-left: 550px; width: calc(100% - 550px); } }
        
        .page-section { display: none; animation: fadeInPage 0.7s ease-out forwards; }
        .page-section.active-section { display: block; }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1, h2, h3, h4, h5, h6 { color: var(--highlight-purple); font-weight: 700; }
        .font-serif { font-family: 'Baloo Bhai 2', cursive; } .font-outfit { font-family: 'Outfit', sans-serif; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: rgba(50, 50, 50, 0.2); } ::-webkit-scrollbar-thumb { background: color-mix(in srgb, var(--highlight-purple) 60%, transparent); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: color-mix(in srgb, var(--highlight-purple) 80%, transparent); }
        #animated-images-container-wrapper { height: calc(100vh - 4rem); position: relative; }
        #animated-images-container { position: relative; width: 100%; height: 100%; }
        .animated-post-image-bubble { position: absolute; border-radius: 50%; overflow: hidden; box-shadow: 0 5px 20px color-mix(in srgb, var(--highlight-purple) 20%, #000000 50%), 0 0 8px rgba(0,0,0,0.2); border: 2px solid color-mix(in srgb, var(--highlight-purple-lighter) 30%, transparent); transition: border-color 0.3s ease; opacity: 0; }
        .animated-post-image-bubble:hover { border-color: color-mix(in srgb, var(--highlight-purple-hover) 70%, transparent); }
        .animated-post-image-bubble img { width: 100%; height: 100%; object-fit: cover; display: block; }
        #writings-content, #about-content { font-size: 17px; }
        
        #writings-grid-container .writing-preview-card,
        #full-articles-container article { max-width: 100%; box-sizing: border-box; }
        .writing-preview-card { background-color: var(--writings-card-bg-color); backdrop-filter: blur(7px); border-radius: 0.75rem; padding: 2rem; border: 1px solid var(--card-border-color); display: flex; flex-direction: column; box-shadow: 0 6px 18px rgba(0,0,0, 0.35), 0 0 8px 1px color-mix(in srgb, var(--highlight-purple) 20%, transparent); position: relative; overflow: hidden; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.4s ease-out, border-color 0.4s ease-out, background-color 0.3s ease; }
        .writing-preview-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, color-mix(in srgb, var(--highlight-purple) 10%, transparent), transparent); transform: translateX(-100%); transition: transform 0.8s ease; pointer-events: none; z-index: 0; }
        .writing-preview-card:hover { background-color: var(--writings-card-hover-bg-color); box-shadow: 0 15px 30px rgba(0,0,0, 0.5), 0 0 20px color-mix(in srgb, var(--highlight-purple) 35%, transparent); border-color: var(--card-hover-border-color); }
        .writing-preview-card:hover::before { transform: translateX(100%); }
        .writing-preview-card h3 { color: #FFFFFF; font-size: 1.55rem; overflow-wrap: break-word; } /* Added overflow-wrap */
        .writing-preview-card .post-meta-info { color: var(--highlight-purple-lighter); }
        .writing-preview-card .excerpt { color: #D1D1D1; overflow-wrap: break-word; /* Ensure excerpt text also wraps */ } 
        .writing-preview-card .line-clamp-4 { /* Tailwind utility should handle this, but let's be explicit */
            overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 4;
        }
        .writing-preview-card a.read-more-link { color: var(--highlight-purple); } .writing-preview-card a.read-more-link:hover { color: var(--highlight-purple-hover); }
        
        #full-articles-container article { background-color: var(--article-bg-color); border: 1px solid var(--card-border-color); border-top: 5px solid var(--highlight-purple); }
        #full-articles-container article:target { display: block !important; opacity: 1 !important; animation: fadeInArticle 0.6s ease-out forwards; }
        #full-articles-container .post-meta-info { color: var(--highlight-purple-lighter); }
        a.back-button { background-color: var(--highlight-purple); color: #FFFFFF; } a.back-button:hover { background-color: var(--highlight-purple-hover); }
        hr.separator { background-image: linear-gradient(to right, transparent, var(--highlight-purple), var(--highlight-purple-hover), var(--highlight-purple), transparent); }
        
        .post-content-html { 
            white-space: pre-line; text-align: left; line-height: 1.7; 
            overflow-wrap: break-word; /* Primary fix for long text leakage */
            word-break: break-word; /* Fallback for older browsers / stricter breaking */
        }
        .post-content-html p, .post-content-html span, .post-content-html div, 
        .post-content-html b, .post-content-html strong, .post-content-html i, 
        .post-content-html em, .post-content-html u { 
            color: #D1D1D1; 
            overflow-wrap: break-word; /* Ensure children also respect word breaking */
            word-break: break-word;
        }
        .post-content-html a { color: var(--highlight-purple); } .post-content-html a:hover { color: var(--highlight-purple-hover); }
        .post-content-html blockquote { border-left: 4px solid var(--highlight-purple); color: #A8A8A8; background-color: rgba(146, 114, 206, 0.05); overflow-wrap: break-word; word-break: break-word; }
        
        /* Glitch button, progress bar, secret game modal styles (mostly unchanged) */
        .glitch-button { /* ... */ } .progress-container { /* ... */ } .progress-bar { /* ... */ } #secret-game-modal { /* ... */ } #matter-canvas { /* ... */ } .game-controls button { /* ... */ } #game-info { /* ... */ }
        
        /* About section styles (mostly unchanged) */
        #about-content .questionnaire-container-wrapper { /* ... */ } .question-block { /* ... */ } .question-block h3 { /* ... */ } .answer-options { /* ... */ } .answer-option { /* ... */ } .feedback-area { /* ... */ } #personality-match-section { /* ... */ } #personality-match-section h2 { /* ... */ } #personality-match-section p { /* ... */ }
        
        @media (max-width: 768px) {
            .site-navbar { width: 100%; height: auto; max-height: 60vh; /* Increased for taller blockquote */ position: static; border-right: none; border-bottom: 1px solid #CCCCCC; padding: 1.5rem 1rem; min-width: unset; max-width: unset; }
            #navbar-agraj-image { width: 50%; max-width: 150px; margin-bottom: 0.5rem;}
            .site-navbar #typewriter { font-size: 0.85rem; min-height: 2em; margin-bottom: 0.75rem; }
            .site-navbar .quote { font-size: 0.9rem; min-height: 5em; margin-bottom: 1.5rem; padding: 1rem; }
            .navbar-links a { padding: 0.6rem 1rem; font-size: 1rem; }
            #navbar-logo-image { width: 45px; margin-top: 1rem; }
            .site-content { margin-left: 0; width: 100%; padding: 1.5rem 1rem; }
            #animated-images-container-wrapper { height: 50vh; /* Adjusted from 60vh as navbar is taller */ }
            .progress-container { display: none; } 
        }
    </style>
</head>
<body>
    <!-- HTML Structure (audio, p5, progress, overlay, site-container, etc.) -->
    <!-- This structure remains the same as your last fully working visual version -->
    <audio id="gameSpawnSound" src="spawn_sound.mp3" preload="auto"></audio>
    <audio id="gameWinSound" src="win_sound.mp3" preload="auto"></audio>
    <audio id="revealSound" src="reveal_sound.mp3" preload="auto"></audio>

    <div id="p5-background-canvas"></div>
    <div class="progress-container"> <div class="progress-bar" id="progressBar"></div> </div> 
    <div class="bg-overlay"></div>

    <div class="site-container">
        <aside class="site-navbar">
            <div class="navbar-top-content">
                <a href="#home" aria-label="Go to Home Page">
                    <img src="agraj.png" alt="Agraj stylized text logo" id="navbar-agraj-image">
                </a>
                <h1 class="text-2xl md:text-3xl font-bold mb-3 tracking-tight font-serif sr-only"> 
                    <span id="main-heading-text"></span>
                </h1> 
                <div id="typewriter" class="mb-4"></div> 
                <blockquote class="quote"> 
                    <span id="blockquote-text"></span> 
                </blockquote>
            </div>
            
            <nav class="navbar-links">
                <a href="#home" data-navlink="home" class="active">Home</a> 
                <a href="#writings" data-navlink="writings">Writings</a> 
                <a href="#about" data-navlink="about">About Me</a> 
                <a href="https://www.reddit.com/user/Federal_Anywhere_559/" target="_blank" rel="noopener noreferrer" data-navlink="reddit">Reddit</a>
                <a href="https://t.me/agraj0669" target="_blank" rel="noopener noreferrer" data-navlink="contact">Contact Me</a> 
            </nav>

            <div class="navbar-bottom">
                <img src="logo.png" alt="Agraj personal logo" id="navbar-logo-image" title="Play a game?">
            </div>
        </aside>

        <main class="site-content">
            <div id="page-container">
                <section id="home-content" class="page-section">
                    <div id="animated-images-container-wrapper">
                        <div id="animated-images-container">
                        </div>
                    </div>
                </section>
                
                <section id="writings-content" class="page-section"> 
                    <div class="text-center mb-12 md:mb-16 pt-8"> 
                        <h1 class="text-4xl md:text-5xl font-bold font-outfit">My Writings</h1> 
                    </div> 
                    <section id="writings-grid-container" class="mb-12 md:mb-20 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8"></section> 
                    <hr class="separator"> 
                    <section id="full-articles-container"> 
                        <div class="full-articles-content max-w-4xl mx-auto" id="full-articles-dynamic-content"></div> 
                    </section> 
                </section>
        
                <section id="about-content" class="page-section">
                    <div class="text-center mb-12 md:mb-16 pt-8">
                        <h1 class="text-4xl md:text-5xl font-bold font-outfit">A Little More About Me</h1>
                        <p class="text-text-subtle mt-4 text-lg">Answer these questions to see how our perspectives align (or amusingly diverge!).</p>
                    </div>
                    <div id="questionnaire-container-wrapper" class="questionnaire-container-wrapper">
                        <div id="questionnaire-render-area">
                            <p class="text-center text-text-subtle">Loading questions...</p>
                        </div>
                        <div id="personality-match-section" class="mt-12" style="display: none; opacity: 0; transform: translateY(20px);">
                            <h2>Personality Snapshot</h2>
                            <p>Your alignment with my perspectives: <span id="match-percentage-value">0</span>%</p>
                            <p>My MBTI Type: <span id="mbti-type-value">INFJ</span></p>
                            <p class="text-sm text-text-tertiary mt-4">Note: This is a simplified alignment based on these specific questions.</p>
                            <a href="https://t.me/agraj0669" target="_blank" rel="noopener noreferrer" id="contact-telegram-btn" class="glitch-button mt-6" data-text="Contact on Telegram!">
                                <span class="btn-text">Contact on Telegram!</span>
                            </a>
                        </div>
                        <div class="text-center">
                             <button id="calculate-match-button" class="glitch-button" data-text="See How We Match!" style="display: none;"><span class="btn-text">See How We Match!</span></button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <div id="secret-game-modal">
        <div id="game-info">
            <p>Shapes dropped: <span id="game-shapes-dropped">0</span>/<span id="game-max-shapes">0</span></p>
            <p>In target: <span id="game-shapes-in-target">0</span>/<span id="game-shapes-to-win">0</span></p>
            <p id="game-win-message" class="game-instructions">Drag shapes into the purple zone!</p>
        </div>
        <canvas id="matter-canvas"></canvas>
        <div class="game-controls">
            <button id="reset-game-button" class="glitch-button" data-text="Reset Game"><span class="btn-text">Reset Game</span></button>
            <button id="close-game-button" class="glitch-button" data-text="Close Game"><span class="btn-text">Close Game</span></button>
        </div>
    </div>

    <script>
        // --- JAVASCRIPT FROM THE PREVIOUS "fix everything" RESPONSE ---
        // (The one with the corrected renderQuestionnaire, setupRotatingText, showMainSection, handleMainRouteChange)
        // This JavaScript should be the complete block you had that was mostly working,
        // but now with the CSS above also updated.

        const APP_CONFIG = { /* ... */ };
        let ALL_QUESTIONNAIRE_DATA = []; let visitorAnswers = {}; let questionsAnsweredCount = 0;
        let revealSound, gameSpawnSoundEl, gameWinSoundEl;
        function $(selector) { return document.querySelector(selector); }
        function $$(selector) { return document.querySelectorAll(selector); }
        let p5Blobs = []; const NUM_P5_BLOBS = 5; 
        function p5Sketch(p) { /* ... p5 code ... */ }
        let ALL_POSTS_DATA = [];
        function simpleMarkdownToHtml(md) { /* ... */ }
        function createPostPreviewCard(post, isForHome = false) { /* ... */ }
        function createFullArticleHtml(post) { /* ... */ }
        async function setupHomePageRightColumnImages() { /* ... */ }
        async function loadAndRenderPosts() { /* ... */ }
        async function renderQuestionnaire() { /* ... (Ensure this has the console.logs and error handling) ... */ }
        function setupQuestionnaireInteractions() { /* ... */ }
        function calculateAndShowMatch() { /* ... */ }
        let matterEngine, matterRender, matterRunner; /* ... Secret Game JS ... */
        function playSound(soundElement) { /* ... */ }
        function resetSecretGame() { /* ... */ }
        function updateGameInfoDisplay() { /* ... */ }
        function setupSecretGame() { /* ... */ }
        let rotatingTextInstances = {};
        function setupRotatingText(elementId, config) { /* ... (direct start for navbar elements) ... */ }
        function setupScrollProgressBar() { /* ... */ }
        function setupWritingsCardHoverEffects() { /* ... */ }
        let currentMainSection = null; let lastClickedReadMoreLink = null; 
        function showMainSection(sectionId) { /* ... (with display:none/block) ... */ }
        function handleMainRouteChange() { /* ... (with robust #home default and section re-evaluation) ... */ }
        function handleWritingsArticleLogic(articleHash) { /* ... */ }
        function isElementInViewport(el) { /* ... */ }
        document.addEventListener('DOMContentLoaded', async () => { /* ... (ensure handleMainRouteChange is called) ... */ });

        // PASTE THE FULL JAVASCRIPT FROM THE PREVIOUS MESSAGE HERE
        // (The one that begins with "const APP_CONFIG = { ..." and ends with the DOMContentLoaded listener)
        // This is just a placeholder comment.
            <script>
        const APP_CONFIG = {
             ROTATING_TEXT_HOME: { 
                 'typewriter': { texts: ["Cause no one listens, so I write instead 😎"], typeSpeed: 80, deleteSpeed: 50, pauseDuration: 3000 },
                 'main-heading-text': { texts: ["agraj", "アグラジ", "अग्रज", "αγραξ"], typeSpeed: 100, deleteSpeed: 60, pauseDuration: 2500 }, 
                 'blockquote-text': { 
                     texts: [
                        "The stream ran bright, water paving away, tap dancing with sunlight.",
                        "Was I born different? What did I do different that made me the way I am?",
                        "Time flies by; for me it does so in gloom. Worries of the future, regrets of the past.",
                        "If a book doesn't change you, even in the slightest, it isn't worth reading.",
                        "All went away for nothing, and all I am now is who I was never supposed to be."
                     ], 
                     typeSpeed: 70, deleteSpeed: 40, pauseDuration: 4500 
                 }
            },
            DEFAULT_TITLES: { home: "agraj - Portfolio", writings: "Writings - Agraj Dubey", about: "About Me - Agraj Dubey" },
            POSTS_JSON_PATH: 'posts.json', QUESTIONS_JSON_PATH: 'questions.json',
            TELEGRAM_USERNAME: 'agraj0669', MATCH_THRESHOLD_FOR_CONTACT: 70
        };
        
        let ALL_QUESTIONNAIRE_DATA = []; let visitorAnswers = {}; let questionsAnsweredCount = 0;
        let revealSound, gameSpawnSoundEl, gameWinSoundEl;

        function $(selector) { return document.querySelector(selector); }
        function $$(selector) { return document.querySelectorAll(selector); }

        let p5Blobs = []; const NUM_P5_BLOBS = 5; 
        function p5Sketch(p) { 
            class Blob {
                constructor() { this.x = p.random(p.width); this.y = p.random(p.height); this.r = p.random(p.width / 3.5, p.width / 1.3); this.xSpeed = p.random(-0.35, 0.35); this.ySpeed = p.random(-0.35, 0.35); this.numPoints = p.int(p.random(6, 12)); this.noiseSeedX = p.random(1000); this.noiseSeedY = p.random(1000); this.noiseSeedR = p.random(1000); this.hueMin = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--p5-blob-hue-min')); this.hueMax = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--p5-blob-hue-max')); this.hue = p.random(this.hueMin, this.hueMax); this.hueShiftSpeed = p.random(-0.12, 0.12); this.opacity = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--p5-blob-opacity')); }
                update() { this.x += this.xSpeed + (p.noise(this.noiseSeedX + p.frameCount * 0.0005) - 0.5) * 0.5; this.y += this.ySpeed + (p.noise(this.noiseSeedY + p.frameCount * 0.0005) - 0.5) * 0.5; this.r = p.map(p.noise(this.noiseSeedR + p.frameCount * 0.0012), 0, 1, p.width / 4.5, p.width / 1.1); if (this.x < -this.r * 1.5) this.x = p.width + this.r * 1.5; if (this.x > p.width + this.r * 1.5) this.x = -this.r * 1.5; if (this.y < -this.r * 1.5) this.y = p.height + this.r * 1.5; if (this.y > p.height + this.r * 1.5) this.y = -this.r * 1.5; this.hue = (this.hue + this.hueShiftSpeed); if (this.hue > this.hueMax) this.hue = this.hueMin; if (this.hue < this.hueMin) this.hue = this.hueMax; }
                display() { p.fill(this.hue, 60, 70, this.opacity); p.beginShape(); let angleStep = p.TWO_PI / this.numPoints; for (let i = 0; i <= this.numPoints; i++) { let angle = i * angleStep; let radiusOffset = p.map(p.noise(this.noiseSeedX + i * 0.2 + p.frameCount * 0.002, this.noiseSeedY + i * 0.2), 0, 1, -this.r * 0.4, this.r * 0.4); let currentR = this.r + radiusOffset; let vx = this.x + currentR * p.cos(angle); let vy = this.y + currentR * p.sin(angle); p.curveVertex(vx, vy); if (i === 0 || i === 1 || i === this.numPoints-1 || i === this.numPoints) { p.curveVertex(vx, vy); } } p.endShape(); }
            }
            p.setup = function() { const p5CanvasContainer = $('#p5-background-canvas'); if (!p5CanvasContainer) { return; } const p5Renderer = p.createCanvas(p.windowWidth, p.windowHeight); p5Renderer.parent(p5CanvasContainer); p.colorMode(p.HSB, 360, 100, 100, 100); p.noStroke(); for (let i = 0; i < NUM_P5_BLOBS; i++) { p5Blobs.push(new Blob()); } };
            p.draw = function() { p.clear(); for (let blob of p5Blobs) { blob.update(); blob.display(); } };
            p.windowResized = function() { p.resizeCanvas(p.windowWidth, p.windowHeight); p5Blobs = []; for (let i = 0; i < NUM_P5_BLOBS; i++) { p5Blobs.push(new Blob()); } };
        }
        
        let ALL_POSTS_DATA = [];
        function simpleMarkdownToHtml(md) { if (typeof md !== 'string') return ''; let html = md; if (html.startsWith('`') && html.endsWith('`') && !html.startsWith('```') && !html.endsWith('```')) { html = html.substring(1, html.length - 1); } html = html.replace(/\r\n/g, '\n'); html = html.replace(/<br\s*\/?>\n?/gi, '\n'); html = html.replace(/\n\s*\n+/g, '<br>\n<br>\n'); html = html.replace(/\n/g, '<br>\n'); html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); html = html.replace(/\\\"/g, '"'); html = html.replace(/(<br>\n\s*){3,}/g, '<br>\n<br>\n'); return html; }
        function createPostPreviewCard(post, isForHome = false) { const cardClass = 'writing-preview-card'; const anchorClass = `read-more-link`; const readMoreTextContent = `Read More →`; const dataText = readMoreTextContent.trim(); return `<div class="${cardClass} rounded-lg p-7 shadow-lg relative overflow-hidden"><h3 class="text-xl lg:text-2xl font-semibold mb-4 group text-hover-scale font-outfit"><span class="transition-all duration-300 inline-block">${post.title}</span></h3><div class="post-meta-info">${new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div><div class="mb-5"><p class="excerpt line-clamp-4">${post.excerpt}</p></div><a href="#${post.id}" class="${anchorClass}" data-text="${dataText}"><span class="btn-text">${readMoreTextContent}</span></a></div>`; }
        function createFullArticleHtml(post) { const htmlContent = simpleMarkdownToHtml(post.contentMarkdown); return `<article id="${post.id}" tabindex="-1"><h2 class="text-hover-scale">${post.title}</h2><div class="post-meta-info">Published: ${new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>${post.image ? `<img src="${post.image}" alt="${post.imageAlt || post.title}" class="my-8 rounded-lg shadow-lg mx-auto max-w-full md:max-w-2xl" loading="lazy">` : ''}<div class="post-content-html">${htmlContent}</div><a href="#writings" class="back-button mt-8 glitch-button" data-text="← Back to Writings"><span class="btn-text">← Back to Writings</span></a></article>`; }
        async function setupHomePageRightColumnImages() { const container = $('#animated-images-container'); const sectionContainer = $('#animated-images-container-wrapper'); if (!container || !sectionContainer) { return; } if (ALL_POSTS_DATA.length === 0) { setTimeout(setupHomePageRightColumnImages, 200); return; } const postsWithImages = ALL_POSTS_DATA.filter(post => post.image).slice(0, 5); if (postsWithImages.length === 0) { container.innerHTML = '<p class="text-text-subtle text-sm text-center md:text-left">No recent visual entries.</p>'; return; } container.innerHTML = ''; const bubbleConfigs = [ { sizeVW: 18, minSize: 150, maxSize: 250, zIndex: 1 }, { sizeVW: 15, minSize: 130, maxSize: 220, zIndex: 3 }, { sizeVW: 20, minSize: 170, maxSize: 280, zIndex: 2 }, { sizeVW: 16, minSize: 140, maxSize: 230, zIndex: 1 }, { sizeVW: 14, minSize: 120, maxSize: 200, zIndex: 3 }]; requestAnimationFrame(() => { const containerWidth = container.offsetWidth; const containerHeight = container.offsetHeight; postsWithImages.forEach((post, index) => { if (index >= bubbleConfigs.length) return; const config = bubbleConfigs[index]; const escapedTitle = post.title.replace(/"/g, '"'); let bubbleSize = Math.max(config.minSize, Math.min(config.maxSize, window.innerWidth * (config.sizeVW / 100))); bubbleSize = Math.min(bubbleSize, (containerWidth > 0 ? containerWidth * 0.8 : config.maxSize), (containerHeight > 0 ? containerHeight * 0.40 : config.maxSize)); const bubbleLink = document.createElement('a'); bubbleLink.href = `#${post.id}`; bubbleLink.classList.add('animated-post-image-bubble'); bubbleLink.setAttribute('aria-label', `Read more about ${escapedTitle}`); bubbleLink.title = escapedTitle; bubbleLink.style.width = `${bubbleSize}px`; bubbleLink.style.height = `${bubbleSize}px`; bubbleLink.style.zIndex = config.zIndex; bubbleLink.style.opacity = 0; const img = document.createElement('img'); img.src = post.image; img.alt = `Preview for ${escapedTitle}`; bubbleLink.appendChild(img); container.appendChild(bubbleLink); }); const imageBubbles = $$('#animated-images-container .animated-post-image-bubble'); if (typeof anime === 'function' && imageBubbles.length > 0) { imageBubbles.forEach((bubble) => { function fizzleAnimation() { const bubbleSize = parseFloat(bubble.style.width); const currentContainerHeight = container.offsetHeight > 0 ? container.offsetHeight : 600; const currentContainerWidth = container.offsetWidth > 0 ? container.offsetWidth : 300; const maxTop = Math.max(0, currentContainerHeight - bubbleSize - 10); const maxLeft = Math.max(0, currentContainerWidth - bubbleSize - 10); const newTop = anime.random(0, maxTop); const newLeft = anime.random(0, maxLeft); bubble.style.top = `${newTop}px`; bubble.style.left = `${newLeft}px`; bubble.style.transform = 'translateX(0px) translateY(0px)'; anime.timeline({ targets: bubble, easing: 'easeOutExpo', complete: fizzleAnimation }).add({ opacity: [0, 0.9], scale: [0.3, 1], duration: anime.random(700, 1000), }).add({ translateX: () => anime.random(-20, 20) + 'px', translateY: () => anime.random(-20, 20) + 'px', scale: () => anime.random(0.9, 1.1), duration: anime.random(3000, 5000), easing: 'easeInOutSine' }, '-=300') .add({ opacity: [bubble.style.opacity, 0], scale: [parseFloat(getComputedStyle(bubble).transform.split(',')[0].split('(')[1]) || 1, 0.2], duration: anime.random(600, 900), easing: 'easeInExpo', delay: anime.random(0, 400) }); } setTimeout(fizzleAnimation, anime.random(0, 2500)); }); } }); }
        async function loadAndRenderPosts() { try { const response = await fetch(APP_CONFIG.POSTS_JSON_PATH); if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}, path: ${APP_CONFIG.POSTS_JSON_PATH}`); } ALL_POSTS_DATA = await response.json(); ALL_POSTS_DATA.sort((a, b) => new Date(b.date) - new Date(a.date)); const writingsGrid = $('#writings-grid-container'); if (writingsGrid) { if (ALL_POSTS_DATA.length > 0) { writingsGrid.innerHTML = ALL_POSTS_DATA.map(post => createPostPreviewCard(post, false)).join(''); } else { writingsGrid.innerHTML = '<p class="text-text-subtle col-span-full text-center">No writings available.</p>'; } setupWritingsCardHoverEffects(); } const fullArticlesTarget = $('#full-articles-dynamic-content'); if (fullArticlesTarget) { fullArticlesTarget.innerHTML = ALL_POSTS_DATA.map(post => createFullArticleHtml(post)).join(''); } if (typeof setupHomePageRightColumnImages === 'function' && currentMainSection === 'home-content') { await setupHomePageRightColumnImages(); } } catch (error) { console.error("ERROR in loadAndRenderPosts:", error); if ($('#writings-grid-container')) $('#writings-grid-container').innerHTML = '<p class="text-text-subtle col-span-full text-center">Error: Could not load writings.</p>'; } }
        
        async function renderQuestionnaire() { const container = $('#questionnaire-render-area'); const calculateButton = $('#calculate-match-button'); const personalityMatchSection = $('#personality-match-section'); const contactTelegramBtn = $('#contact-telegram-btn'); if (!container || !calculateButton || !personalityMatchSection || !contactTelegramBtn) { if(container) container.innerHTML = '<p class="text-text-subtle text-center">Core UI elements missing.</p>'; return; } container.innerHTML = '<p class="text-center text-text-subtle">Loading questions...</p>'; try { console.log("Fetching:", APP_CONFIG.QUESTIONS_JSON_PATH); const response = await fetch(APP_CONFIG.QUESTIONS_JSON_PATH); if (!response.ok) { const errorText = await response.text(); console.error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}, path: ${APP_CONFIG.QUESTIONS_JSON_PATH}`); console.error("Response text:", errorText); throw new Error(`HTTP error! status: ${response.status} for ${APP_CONFIG.QUESTIONS_JSON_PATH}`); } ALL_QUESTIONNAIRE_DATA = await response.json(); console.log("Questions loaded:", ALL_QUESTIONNAIRE_DATA); } catch (error) { console.error("Error loading/parsing questionnaire data:", error); let userErrorMessage = "Error: Could not load questions. Check console."; if (error.message.includes("HTTP error")) { userErrorMessage = `Error: Could not fetch questions. Path: ${APP_CONFIG.QUESTIONS_JSON_PATH}`; } else if (error instanceof SyntaxError) { userErrorMessage = `Error: questions.json malformed. Path: ${APP_CONFIG.QUESTIONS_JSON_PATH}`; } container.innerHTML = `<p class="text-text-subtle text-center">${userErrorMessage}</p>`; return; } if (!Array.isArray(ALL_QUESTIONNAIRE_DATA) || ALL_QUESTIONNAIRE_DATA.length === 0) { container.innerHTML = '<p class="text-text-subtle text-center">No questions available or data format error.</p>'; return; } let html = ''; ALL_QUESTIONNAIRE_DATA.forEach((q) => { html += `<div class="question-block" id="question-${q.id}" data-question-id="${q.id}"><h3>${q.questionText}</h3><div class="answer-options">`; q.options.forEach((opt) => { const escapedOptionText = String(opt.text).replace(/"/g, '"'); html += `<button class="answer-option" data-option-text="${escapedOptionText}">${opt.text}</button>`; }); html += `</div><div class="feedback-area" id="feedback-${q.id}"></div></div>`; }); container.innerHTML = html; if (typeof anime === 'function') { anime({ targets: '.question-block', translateY: [30, 0], opacity: [0, 1], delay: anime.stagger(120, { start: 100 }), duration: 600, easing: 'easeOutExpo' }); } visitorAnswers = {}; questionsAnsweredCount = 0; personalityMatchSection.style.display = 'none'; personalityMatchSection.classList.remove('visible'); personalityMatchSection.style.opacity = '0'; personalityMatchSection.style.transform = 'translateY(20px)'; contactTelegramBtn.style.display = 'none'; calculateButton.style.display = 'none'; calculateButton.disabled = true; setupQuestionnaireInteractions(); }
        function setupQuestionnaireInteractions() { const answerOptionButtons = $$('#questionnaire-render-area .answer-option'); answerOptionButtons.forEach(button => { button.addEventListener('click', function() { const questionBlock = this.closest('.question-block'); if (questionBlock.classList.contains('answered')) return; const questionId = questionBlock.dataset.questionId; const selectedOptionText = this.dataset.optionText; const questionData = ALL_QUESTIONNAIRE_DATA.find(q => q.id === questionId); if (!questionData) return; const selectedOptionData = questionData.options.find(opt => opt.text === selectedOptionText); if (!selectedOptionData) return; questionBlock.classList.add('answered'); if (!visitorAnswers.hasOwnProperty(questionId)) questionsAnsweredCount++; visitorAnswers[questionId] = selectedOptionText; const optionsInBlock = questionBlock.querySelectorAll('.answer-option'); optionsInBlock.forEach(opt => { opt.disabled = true; opt.classList.remove('selected-visitor', 'selected-visitor-wrong', 'agraj-correct-answer'); if (opt !== this && opt.dataset.optionText !== questionData.agrajAnswerText && typeof anime === 'function') { anime({ targets: opt, opacity: 0.4, scale: 0.95, duration: 400, easing: 'easeOutQuad' }); } }); let animParams = { targets: this, duration: 400, easing: 'easeOutBack' }; if (selectedOptionText === questionData.agrajAnswerText) { this.classList.add('selected-visitor'); animParams.scale = [1, 1.05, 1]; } else { this.classList.add('selected-visitor-wrong'); const agrajAnswerButton = Array.from(optionsInBlock).find(optBtn => optBtn.dataset.optionText === questionData.agrajAnswerText); if (agrajAnswerButton) { agrajAnswerButton.classList.add('agraj-correct-answer'); if (typeof anime === 'function') { anime({ targets: agrajAnswerButton, scale: [1, 1.03, 1], duration: 400, delay:100, easing: 'easeOutBack' }); } } } if (typeof anime === 'function') anime(animParams); const feedbackArea = questionBlock.querySelector('.feedback-area'); feedbackArea.innerHTML = selectedOptionData.feedback; feedbackArea.classList.add('visible'); if (typeof anime === 'function') { anime({ targets: feedbackArea, opacity: [0, 1], translateY: [10,0], duration: 500, delay: 200, easing: 'easeOutExpo' }); } const calculateButton = $('#calculate-match-button'); if (ALL_QUESTIONNAIRE_DATA.length > 0 && questionsAnsweredCount === ALL_QUESTIONNAIRE_DATA.length) { calculateButton.style.display = 'inline-block'; calculateButton.disabled = false; if (typeof anime === 'function') { anime({ targets: calculateButton, opacity: [0, 1], scale: [0.8, 1], duration: 500, easing: 'easeOutExpo' }); } } else { calculateButton.style.display = 'none'; calculateButton.disabled = true; } }); }); const calculateButton = $('#calculate-match-button'); if (calculateButton) calculateButton.addEventListener('click', calculateAndShowMatch); }
        function calculateAndShowMatch() { const calcButton = $('#calculate-match-button'); if(calcButton) calcButton.disabled = true; if (ALL_QUESTIONNAIRE_DATA.length === 0 || questionsAnsweredCount < ALL_QUESTIONNAIRE_DATA.length) return; let matches = 0; ALL_QUESTIONNAIRE_DATA.forEach(qData => { const visitorSelectedText = visitorAnswers[qData.id]; if (visitorSelectedText && typeof visitorSelectedText === 'string' && typeof qData.agrajAnswerText === 'string' && visitorSelectedText.trim() === qData.agrajAnswerText.trim()) { matches++; } }); const totalQuestions = ALL_QUESTIONNAIRE_DATA.length; const percentage = totalQuestions > 0 ? Math.round((matches / totalQuestions) * 100) : 0; const percentageEl = $('#match-percentage-value'); const personalityMatchSection = $('#personality-match-section'); const contactTelegramBtn = $('#contact-telegram-btn'); if (!percentageEl || !personalityMatchSection || !contactTelegramBtn) return; percentageEl.textContent = percentage; percentageEl.style.opacity = '0'; percentageEl.style.transform = 'scale(0.5)'; if (revealSound && typeof revealSound.play === 'function') { revealSound.currentTime = 0; revealSound.play().catch(e => console.warn("Reveal sound play failed:", e)); } personalityMatchSection.style.display = 'block'; setTimeout(() => { if (typeof anime === 'function') { anime.timeline({ easing: 'easeOutExpo' }).add({ targets: personalityMatchSection, opacity: [0, 1], translateY: [30, 0], duration: 700, begin: () => personalityMatchSection.classList.add('visible') }).add({ targets: percentageEl, opacity: [0,1], scale: [0.5, 1.1, 1], duration: 800, }, '-=400') .add({ targets: [$('#personality-match-section h2'), $('#personality-match-section p'), $('#personality-match-section #mbti-type-value')], opacity: [0,1], translateY: [10,0], delay: anime.stagger(100), duration: 500 }, '-=500').finished.then(() => { personalityMatchSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); if (percentage >= APP_CONFIG.MATCH_THRESHOLD_FOR_CONTACT) { contactTelegramBtn.style.display = 'inline-block'; anime({targets: contactTelegramBtn, opacity: [0,1], scale: [0.8,1], duration: 500, easing: 'easeOutExpo'}); } else { contactTelegramBtn.style.display = 'none'; } }); } else { percentageEl.style.opacity = '1'; percentageEl.style.transform = 'scale(1)'; personalityMatchSection.style.opacity = '1'; personalityMatchSection.style.transform = 'translateY(0)'; personalityMatchSection.classList.add('visible'); personalityMatchSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); if (percentage >= APP_CONFIG.MATCH_THRESHOLD_FOR_CONTACT) { contactTelegramBtn.style.display = 'inline-block'; } else { contactTelegramBtn.style.display = 'none'; } } }, 50); }

        let matterEngine, matterRender, matterRunner; let gameShapes = []; const MAX_SHAPES_TO_SPAWN = 10; const SHAPES_TO_WIN = 3; let shapesSpawned = 0; let gameHasBeenWon = false; let targetZoneBody;
        function playSound(soundElement) { if (soundElement && typeof soundElement.play === 'function') { soundElement.currentTime = 0; soundElement.play().catch(e => console.warn("Game sound play failed:", e.message)); } }
        function resetSecretGame() { gameHasBeenWon = false; shapesSpawned = 0; if (matterEngine) Matter.Composite.clear(matterEngine.world, false); gameShapes = []; const canvas = $('#matter-canvas'); if (!canvas || !matterEngine) return; const canvasWidth = parseFloat(canvas.width); const canvasHeight = parseFloat(canvas.height); const ground = Matter.Bodies.rectangle(canvasWidth / 2, canvasHeight - 10, canvasWidth + 20, 60, { isStatic: true, render: { fillStyle: '#6a4a9a' } }); const leftWall = Matter.Bodies.rectangle(-30, canvasHeight / 2, 60, canvasHeight, { isStatic: true, render: { fillStyle: '#6a4a9a' } }); const rightWall = Matter.Bodies.rectangle(canvasWidth + 30, canvasHeight / 2, 60, canvasHeight, { isStatic: true, render: { fillStyle: '#6a4a9a' } }); const targetZoneHeight = 50; const targetZoneY = canvasHeight - 30 - (targetZoneHeight / 2) - 10; targetZoneBody = Matter.Bodies.rectangle(canvasWidth / 2, targetZoneY, canvasWidth * 0.5, targetZoneHeight, { isStatic: true, isSensor: true, label: 'targetZone', render: { fillStyle: 'rgba(174, 139, 213, 0.35)', strokeStyle: 'rgba(203, 184, 232, 0.6)', lineWidth: 2 } }); Matter.Composite.add(matterEngine.world, [ground, leftWall, rightWall, targetZoneBody]); updateGameInfoDisplay(); if ($('#game-win-message')) $('#game-win-message').textContent = "Drag shapes into the purple zone!"; }
        function updateGameInfoDisplay() { if ($('#game-shapes-dropped')) $('#game-shapes-dropped').textContent = shapesSpawned; if ($('#game-max-shapes')) $('#game-max-shapes').textContent = MAX_SHAPES_TO_SPAWN; let shapesInTargetCount = 0; if (targetZoneBody && gameShapes.length > 0) { gameShapes.forEach(shape => { if (Matter.Bounds.overlaps(shape.bounds, targetZoneBody.bounds) && shape.position.y > targetZoneBody.bounds.min.y && shape.position.y < targetZoneBody.bounds.max.y && Math.abs(shape.velocity.x) < 0.1 && Math.abs(shape.velocity.y) < 0.1) { shapesInTargetCount++; } }); } if ($('#game-shapes-in-target')) $('#game-shapes-in-target').textContent = shapesInTargetCount; if ($('#game-shapes-to-win')) $('#game-shapes-to-win').textContent = SHAPES_TO_WIN; const winMessageEl = $('#game-win-message'); if (winMessageEl) { if (!gameHasBeenWon && shapesInTargetCount >= SHAPES_TO_WIN) { gameHasBeenWon = true; winMessageEl.textContent = "YOU WIN! ✨"; playSound(gameWinSoundEl); if (typeof anime === 'function') { anime({ targets: winMessageEl, scale: [1, 1.2, 1], color: ['#AE8BD5', '#FFFFFF', '#AE8BD5'], duration: 1000, easing: 'easeInOutQuad' }); } } else if (!gameHasBeenWon && shapesSpawned >= MAX_SHAPES_TO_SPAWN && shapesInTargetCount < SHAPES_TO_WIN) { winMessageEl.textContent = "Out of shapes! Try again?"; } } }
        function setupSecretGame() { const trigger = $('#navbar-logo-image'); const modal = $('#secret-game-modal'); const canvas = $('#matter-canvas'); const closeButton = $('#close-game-button'); const resetButton = $('#reset-game-button'); if (!trigger || !modal || !canvas || !closeButton || !resetButton || typeof Matter === 'undefined') { if(trigger) trigger.style.display = 'none'; return; } const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, Bodies = Matter.Bodies, Composite = Matter.Composite, Mouse = Matter.Mouse, MouseConstraint = Matter.MouseConstraint, Events = Matter.Events; trigger.addEventListener('click', () => { modal.style.display = 'flex'; if (typeof anime === 'function') { anime({ targets: modal, opacity: [0,1], scale: [0.9, 1], duration: 400, easing: 'easeOutExpo' }); } if (matterRender) Matter.Render.stop(matterRender); if (matterRunner) Runner.stop(matterRunner); if (matterEngine) Matter.Engine.clear(matterEngine); if (canvas.firstChild && canvas.firstChild.tagName === 'CANVAS') { canvas.removeChild(canvas.firstChild); } matterEngine = Engine.create({ gravity: { y: 0.7 } }); let canvasWidth = Math.min(window.innerWidth * 0.85, 700); let canvasHeight = Math.min(window.innerHeight * 0.75, 450); canvas.width = canvasWidth; canvas.height = canvasHeight; matterRender = Render.create({ element: modal, canvas: canvas, engine: matterEngine, options: { width: canvasWidth, height: canvasHeight, wireframes: false, background: 'transparent' } }); resetSecretGame(); const mouse = Mouse.create(matterRender.canvas); const mouseConstraint = MouseConstraint.create(matterEngine, { mouse: mouse, constraint: { stiffness: 0.1, render: { visible: false } } }); Composite.add(matterEngine.world, mouseConstraint); matterRender.mouse = mouse; Events.on(mouseConstraint, 'mousedown', (event) => { if (gameHasBeenWon || shapesSpawned >= MAX_SHAPES_TO_SPAWN) return; const mousePosition = event.mouse.position; let body; const size = Math.random() * 20 + 15; const color = ['#CBB8E8', '#AE8BD5', '#FFFFFF', '#9272CE'][Math.floor(Math.random() * 4)]; if (shapesSpawned % 2 === 0) { body = Bodies.rectangle(mousePosition.x, mousePosition.y, size, size, { render: { fillStyle: color }, frictionAir: 0.03, restitution: 0.4 }); } else { body = Bodies.circle(mousePosition.x, mousePosition.y, size / 1.8, { render: { fillStyle: color }, frictionAir: 0.02, restitution: 0.6 }); } Composite.add(matterEngine.world, body); gameShapes.push(body); shapesSpawned++; playSound(gameSpawnSoundEl); updateGameInfoDisplay(); }); Events.on(matterEngine, 'afterUpdate', updateGameInfoDisplay); Render.run(matterRender); matterRunner = Runner.create(); Runner.run(matterRunner, matterEngine); }); closeButton.addEventListener('click', () => { if (typeof anime === 'function') { anime({ targets: modal, opacity: [1,0], scale: [1, 0.9], duration: 300, easing: 'easeInExpo', complete: () => modal.style.display = 'none' }); } else { modal.style.display = 'none'; } if (matterRender) Matter.Render.stop(matterRender); if (matterRunner) Runner.stop(matterRunner); if (matterEngine) Matter.Engine.clear(matterEngine); }); resetButton.addEventListener('click', resetSecretGame); }
        
        let rotatingTextInstances = {};
        function setupRotatingText(elementId, config) { 
            if (rotatingTextInstances[elementId]) { return; }
            const element = document.getElementById(elementId);
            if (!element) { console.warn(`Rotating text element not found: #${elementId}`); return; }
            let currentIndex = -1, isBusy = false, cycleTimeout = null;
            const runOnce = (elementId === 'typewriter' || config.texts.length === 1);
            element.textContent = ''; 
            function typeWriterInternal(text, callback) {
                let i = 0; isBusy = true;
                function type() {
                    if (!isBusy) { isBusy = false; return; }
                    if (i < text.length) { element.textContent += text.charAt(i); i++; setTimeout(type, config.typeSpeed); } 
                    else { const existingCursor = element.querySelector('.typed-cursor'); if (existingCursor) existingCursor.remove(); const cursor = document.createElement('span'); cursor.className = 'typed-cursor'; element.appendChild(cursor); isBusy = false; if (callback) callback(); }
                } type();
            }
            function deleteWriterInternal(callback) {
                if (runOnce && element.textContent.length > 0) { const existingCursor = element.querySelector('.typed-cursor'); if (!existingCursor) { const cursor = document.createElement('span'); cursor.className = 'typed-cursor'; element.appendChild(cursor); } if (callback) callback(); return; }
                let text = element.textContent; const existingCursor = element.querySelector('.typed-cursor'); if (existingCursor) existingCursor.remove(); text = element.textContent; let i = text.length; isBusy = true;
                function del() {
                     if (!isBusy) { isBusy = false; return; }
                    if (i > 0) { element.textContent = text.substring(0, i - 1); i--; if (!element.querySelector('.typed-cursor') && element.textContent.length > 0) { const cursor = document.createElement('span'); cursor.className = 'typed-cursor'; element.appendChild(cursor); } setTimeout(del, config.deleteSpeed); } 
                    else { const finalCursor = element.querySelector('.typed-cursor'); if (finalCursor) finalCursor.remove(); element.textContent = ''; isBusy = false; if (callback) callback(); }
                } del();
            }
            function scheduleCycle(delay) { if (runOnce) return; clearTimeout(cycleTimeout); cycleTimeout = setTimeout(startCycle, delay); }
            function startCycle() {
                if (runOnce || isBusy) return; 
                deleteWriterInternal(() => {
                    let nextIndex; do { nextIndex = Math.floor(Math.random() * config.texts.length); } while (nextIndex === currentIndex && config.texts.length > 1);
                    currentIndex = nextIndex; const nextText = config.texts[currentIndex];
                    element.textContent = ''; typeWriterInternal(nextText, () => scheduleCycle(config.pauseDuration));
                });
            }
            currentIndex = runOnce ? 0 : (elementId === 'main-heading-text' ? 0 : Math.floor(Math.random() * config.texts.length));
            const firstText = config.texts[currentIndex]; element.textContent = ''; 
            typeWriterInternal(firstText, () => { if (!runOnce) scheduleCycle(config.pauseDuration); });
        }
        
        function setupScrollProgressBar() { const progressBar = $("#progressBar"); if (!progressBar) return; window.addEventListener('scroll', () => { const winScroll = document.body.scrollTop || document.documentElement.scrollTop; const height = document.documentElement.scrollHeight - document.documentElement.clientHeight; const scrolled = height > 0 ? (winScroll / height) * 100 : 0; progressBar.style.width = scrolled + "%"; }, { passive: true }); }
        function setupWritingsCardHoverEffects() { $$('#writings-content .writing-preview-card').forEach(card => { card.addEventListener('mousemove', (e) => { const rect = card.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; const centerX = rect.width / 2; const centerY = rect.height / 2; const rotateX = (y - centerY) / 20; const rotateY = (centerX - x) / 20; card.style.transition = 'transform 0.1s ease-out'; card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateZ(20px)`; }); card.addEventListener('mouseleave', () => { card.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; card.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) translateZ(0px)'; }); card.querySelectorAll('a').forEach(link => { link.addEventListener('click', (e) => e.stopPropagation()); }); }); }
        
        let currentMainSection = null; let lastClickedReadMoreLink = null; 
        function showMainSection(sectionId) { 
            const previouslyActiveSection = $('.page-section.active-section');
            if (previouslyActiveSection) { previouslyActiveSection.classList.remove('active-section'); previouslyActiveSection.style.display = 'none'; }
            const targetSection = $(`#${sectionId}`);
            if (targetSection) {
                targetSection.style.display = 'block'; targetSection.classList.add('active-section'); currentMainSection = sectionId;
                $$('.site-navbar .navbar-links a').forEach(navLink => { navLink.classList.remove('active'); const navTarget = navLink.dataset.navlink; if ( (sectionId === 'home-content' && navTarget === 'home') || (sectionId === 'writings-content' && navTarget === 'writings') || (sectionId === 'about-content' && navTarget === 'about') ) { navLink.classList.add('active'); } });
                if (sectionId === 'about-content' && typeof renderQuestionnaire === 'function') { renderQuestionnaire(); } 
                else if (sectionId === 'home-content' && typeof setupHomePageRightColumnImages === 'function') { 
                    const existingBubbles = $$('#animated-images-container .animated-post-image-bubble');
                    if (existingBubbles.length === 0 && ALL_POSTS_DATA.length > 0) { setupHomePageRightColumnImages(); }
                }
                window.scrollTo({ top: 0, behavior: 'auto' });
            } else { console.warn(`Target section #${sectionId} not found.`); }
        }
        function handleMainRouteChange() { 
            let mainSectionTarget = 'home-content'; let articleDetailHash = '';
            const currentFullHash = window.location.hash;
            if (currentFullHash.startsWith('#post-')) { mainSectionTarget = 'writings-content'; articleDetailHash = currentFullHash; } 
            else if (currentFullHash === '#writings') { mainSectionTarget = 'writings-content'; } 
            else if (currentFullHash === '#about') { mainSectionTarget = 'about-content'; } 
            else if (currentFullHash === '#home' || currentFullHash === '' || currentFullHash === '#') {
                mainSectionTarget = 'home-content'; 
                if (currentFullHash === '' || currentFullHash === '#') {
                    if (window.history.replaceState) { window.history.replaceState(null, '', '#home'); } else { window.location.hash = '#home'; }
                }
            } else { 
                const isExternalNav = Array.from($$('.site-navbar .navbar-links a[target="_blank"]')).some(link => link.href.endsWith(currentFullHash) || `#${link.dataset.navlink}` === currentFullHash);
                if (!isExternalNav) { if (window.history.replaceState) { window.history.replaceState(null, '', '#home'); } else { window.location.hash = '#home'; } mainSectionTarget = 'home-content'; } 
                else { return; }
            }
            if (currentMainSection !== mainSectionTarget || mainSectionTarget === 'home-content' || (mainSectionTarget === 'writings-content' && articleDetailHash)) {
                 showMainSection(mainSectionTarget);
            }
            if (mainSectionTarget === 'writings-content' && typeof handleWritingsArticleLogic === 'function') { handleWritingsArticleLogic(articleDetailHash); document.title = articleDetailHash ? ($(`#${articleDetailHash.substring(1)} h2`)?.textContent + " - Writings") : APP_CONFIG.DEFAULT_TITLES.writings; } 
            else if (mainSectionTarget === 'about-content') { document.title = APP_CONFIG.DEFAULT_TITLES.about; } 
            else if (mainSectionTarget === 'home-content') { document.title = APP_CONFIG.DEFAULT_TITLES.home; }
        }
        function handleWritingsArticleLogic(articleHash) { const defaultWritingsTitle = APP_CONFIG.DEFAULT_TITLES.writings; if (articleHash && articleHash.startsWith('#post-')) { const targetId = articleHash.substring(1); const targetArticle = $(`#${targetId}`); if (targetArticle) { const titleElement = targetArticle.querySelector('h2'); const articleTitle = titleElement ? titleElement.textContent.trim() : "Article"; document.title = `${articleTitle} - Writings - Agraj Dubey`; if (currentMainSection !== 'writings-content') { showMainSection('writings-content'); } setTimeout(() => { if (!isElementInViewport(targetArticle)) targetArticle.scrollIntoView({ behavior: 'smooth', block: 'start' }); const heading = targetArticle.querySelector('h2'); if (heading) { heading.setAttribute('tabindex', '-1'); heading.focus({ preventScroll: true }); } }, 100); } else { document.title = defaultWritingsTitle; } } else { document.title = defaultWritingsTitle; const grid = $('#writings-grid-container'); if (grid && lastClickedReadMoreLink && document.body.contains(lastClickedReadMoreLink)) { setTimeout(() => { lastClickedReadMoreLink.focus({preventScroll: true}); if (!isElementInViewport(lastClickedReadMoreLink)) lastClickedReadMoreLink.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 50); } else if (grid) { setTimeout(() => { grid.setAttribute('tabindex', '-1'); grid.focus({preventScroll: true}); if (!isElementInViewport(grid)) grid.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50); } lastClickedReadMoreLink = null; } }
        function isElementInViewport(el) { if(!el) return false; const rect = el.getBoundingClientRect(); return (rect.top >= 0 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth)); }
        
        document.addEventListener('DOMContentLoaded', async () => {
            revealSound = $('#revealSound'); gameSpawnSoundEl = $('#gameSpawnSound'); gameWinSoundEl = $('#gameWinSound');
            if (typeof p5 !== 'undefined') { new p5(p5Sketch); } else { console.error("p5.js is not loaded!"); }
            setupScrollProgressBar();
            await loadAndRenderPosts(); 
            for (const elId in APP_CONFIG.ROTATING_TEXT_HOME) { if (document.getElementById(elId) && typeof setupRotatingText === 'function') { setupRotatingText(elId, APP_CONFIG.ROTATING_TEXT_HOME[elId]); } }
            document.body.addEventListener('click', function(event) { const clickedLink = event.target.closest('a.glitch-button[href^="#post-"], a.read-more-link[href^="#post-"]'); if (clickedLink) { lastClickedReadMoreLink = clickedLink; } });
            handleMainRouteChange();
            window.addEventListener('hashchange', handleMainRouteChange); 
            setupSecretGame(); 
            window.addEventListener('resize', () => { if (currentMainSection === 'home-content' && typeof setupHomePageRightColumnImages === 'function') { clearTimeout(window.resizeHomeImagesTimeout); window.resizeHomeImagesTimeout = setTimeout(setupHomePageRightColumnImages, 250); } });
        });
    </script>

        // --- Start of JS from previous functional state ---
        const APP_CONFIG_PREV = {
             ROTATING_TEXT_HOME: { 
                 'typewriter': { texts: ["Cause no one listens, so I write instead 😎"], typeSpeed: 80, deleteSpeed: 50, pauseDuration: 3000 },
                 'main-heading-text': { texts: ["agraj", "アグラジ", "अग्रज", "αγραξ"], typeSpeed: 100, deleteSpeed: 60, pauseDuration: 2500 }, 
                 'blockquote-text': { 
                     texts: [
                        "The stream ran bright, water paving away, tap dancing with sunlight.",
                        "Was I born different? What did I do different that made me the way I am?",
                        "Time flies by; for me it does so in gloom. Worries of the future, regrets of the past.",
                        "If a book doesn't change you, even in the slightest, it isn't worth reading.",
                        "All went away for nothing, and all I am now is who I was never supposed to be."
                     ], 
                     typeSpeed: 70, deleteSpeed: 40, pauseDuration: 4500 
                 }
            },
            DEFAULT_TITLES_PREV: { home: "agraj - Portfolio", writings: "Writings - Agraj Dubey", about: "About Me - Agraj Dubey" },
            POSTS_JSON_PATH_PREV: 'posts.json', QUESTIONS_JSON_PATH_PREV: 'questions.json',
            TELEGRAM_USERNAME_PREV: 'agraj0669', MATCH_THRESHOLD_FOR_CONTACT_PREV: 70
        };
        
        let ALL_QUESTIONNAIRE_DATA_PREV = []; let visitorAnswers_PREV = {}; let questionsAnsweredCount_PREV = 0;
        let revealSound_PREV, gameSpawnSoundEl_PREV, gameWinSoundEl_PREV;

        function $_PREV(selector) { return document.querySelector(selector); }
        function $$_PREV(selector) { return document.querySelectorAll(selector); }

        let p5Blobs_PREV = []; const NUM_P5_BLOBS_PREV = 5; 
        function p5Sketch_PREV(p) { 
            class Blob {
                constructor() { this.x = p.random(p.width); this.y = p.random(p.height); this.r = p.random(p.width / 3.5, p.width / 1.3); this.xSpeed = p.random(-0.35, 0.35); this.ySpeed = p.random(-0.35, 0.35); this.numPoints = p.int(p.random(6, 12)); this.noiseSeedX = p.random(1000); this.noiseSeedY = p.random(1000); this.noiseSeedR = p.random(1000); this.hueMin = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--p5-blob-hue-min')); this.hueMax = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--p5-blob-hue-max')); this.hue = p.random(this.hueMin, this.hueMax); this.hueShiftSpeed = p.random(-0.12, 0.12); this.opacity = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--p5-blob-opacity')); }
                update() { this.x += this.xSpeed + (p.noise(this.noiseSeedX + p.frameCount * 0.0005) - 0.5) * 0.5; this.y += this.ySpeed + (p.noise(this.noiseSeedY + p.frameCount * 0.0005) - 0.5) * 0.5; this.r = p.map(p.noise(this.noiseSeedR + p.frameCount * 0.0012), 0, 1, p.width / 4.5, p.width / 1.1); if (this.x < -this.r * 1.5) this.x = p.width + this.r * 1.5; if (this.x > p.width + this.r * 1.5) this.x = -this.r * 1.5; if (this.y < -this.r * 1.5) this.y = p.height + this.r * 1.5; if (this.y > p.height + this.r * 1.5) this.y = -this.r * 1.5; this.hue = (this.hue + this.hueShiftSpeed); if (this.hue > this.hueMax) this.hue = this.hueMin; if (this.hue < this.hueMin) this.hue = this.hueMax; }
                display() { p.fill(this.hue, 60, 70, this.opacity); p.beginShape(); let angleStep = p.TWO_PI / this.numPoints; for (let i = 0; i <= this.numPoints; i++) { let angle = i * angleStep; let radiusOffset = p.map(p.noise(this.noiseSeedX + i * 0.2 + p.frameCount * 0.002, this.noiseSeedY + i * 0.2), 0, 1, -this.r * 0.4, this.r * 0.4); let currentR = this.r + radiusOffset; let vx = this.x + currentR * p.cos(angle); let vy = this.y + currentR * p.sin(angle); p.curveVertex(vx, vy); if (i === 0 || i === 1 || i === this.numPoints-1 || i === this.numPoints) { p.curveVertex(vx, vy); } } p.endShape(); }
            }
            p.setup = function() { const p5CanvasContainer = $_PREV('#p5-background-canvas'); if (!p5CanvasContainer) { return; } const p5Renderer = p.createCanvas(p.windowWidth, p.windowHeight); p5Renderer.parent(p5CanvasContainer); p.colorMode(p.HSB, 360, 100, 100, 100); p.noStroke(); for (let i = 0; i < NUM_P5_BLOBS_PREV; i++) { p5Blobs_PREV.push(new Blob()); } };
            p.draw = function() { p.clear(); for (let blob of p5Blobs_PREV) { blob.update(); blob.display(); } };
            p.windowResized = function() { p.resizeCanvas(p.windowWidth, p.windowHeight); p5Blobs_PREV = []; for (let i = 0; i < NUM_P5_BLOBS_PREV; i++) { p5Blobs_PREV.push(new Blob()); } };
        }
        
        let ALL_POSTS_DATA_PREV = [];
        function simpleMarkdownToHtml_PREV(md) { if (typeof md !== 'string') return ''; let html = md; if (html.startsWith('`') && html.endsWith('`') && !html.startsWith('```') && !html.endsWith('```')) { html = html.substring(1, html.length - 1); } html = html.replace(/\r\n/g, '\n'); html = html.replace(/<br\s*\/?>\n?/gi, '\n'); html = html.replace(/\n\s*\n+/g, '<br>\n<br>\n'); html = html.replace(/\n/g, '<br>\n'); html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); html = html.replace(/\\\"/g, '"'); html = html.replace(/(<br>\n\s*){3,}/g, '<br>\n<br>\n'); return html; }
        function createPostPreviewCard_PREV(post, isForHome = false) { const cardClass = 'writing-preview-card'; const anchorClass = `read-more-link`; const readMoreTextContent = `Read More →`; const dataText = readMoreTextContent.trim(); return `<div class="${cardClass} rounded-lg p-7 shadow-lg relative overflow-hidden"><h3 class="text-xl lg:text-2xl font-semibold mb-4 group text-hover-scale font-outfit"><span class="transition-all duration-300 inline-block">${post.title}</span></h3><div class="post-meta-info">${new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div><div class="mb-5"><p class="excerpt line-clamp-4">${post.excerpt}</p></div><a href="#${post.id}" class="${anchorClass}" data-text="${dataText}"><span class="btn-text">${readMoreTextContent}</span></a></div>`; }
        function createFullArticleHtml_PREV(post) { const htmlContent = simpleMarkdownToHtml_PREV(post.contentMarkdown); return `<article id="${post.id}" tabindex="-1"><h2 class="text-hover-scale">${post.title}</h2><div class="post-meta-info">Published: ${new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>${post.image ? `<img src="${post.image}" alt="${post.imageAlt || post.title}" class="my-8 rounded-lg shadow-lg mx-auto max-w-full md:max-w-2xl" loading="lazy">` : ''}<div class="post-content-html">${htmlContent}</div><a href="#writings" class="back-button mt-8 glitch-button" data-text="← Back to Writings"><span class="btn-text">← Back to Writings</span></a></article>`; }
        async function setupHomePageRightColumnImages_PREV() { const container = $_PREV('#animated-images-container'); const sectionContainer = $_PREV('#animated-images-container-wrapper'); if (!container || !sectionContainer) { return; } if (ALL_POSTS_DATA_PREV.length === 0) { setTimeout(setupHomePageRightColumnImages_PREV, 200); return; } const postsWithImages = ALL_POSTS_DATA_PREV.filter(post => post.image).slice(0, 5); if (postsWithImages.length === 0) { container.innerHTML = '<p class="text-text-subtle text-sm text-center md:text-left">No recent visual entries.</p>'; return; } container.innerHTML = ''; const bubbleConfigs = [ { sizeVW: 18, minSize: 150, maxSize: 250, zIndex: 1 }, { sizeVW: 15, minSize: 130, maxSize: 220, zIndex: 3 }, { sizeVW: 20, minSize: 170, maxSize: 280, zIndex: 2 }, { sizeVW: 16, minSize: 140, maxSize: 230, zIndex: 1 }, { sizeVW: 14, minSize: 120, maxSize: 200, zIndex: 3 }]; requestAnimationFrame(() => { const containerWidth = container.offsetWidth; const containerHeight = container.offsetHeight; postsWithImages.forEach((post, index) => { if (index >= bubbleConfigs.length) return; const config = bubbleConfigs[index]; const escapedTitle = post.title.replace(/"/g, '"'); let bubbleSize = Math.max(config.minSize, Math.min(config.maxSize, window.innerWidth * (config.sizeVW / 100))); bubbleSize = Math.min(bubbleSize, (containerWidth > 0 ? containerWidth * 0.8 : config.maxSize), (containerHeight > 0 ? containerHeight * 0.40 : config.maxSize)); const bubbleLink = document.createElement('a'); bubbleLink.href = `#${post.id}`; bubbleLink.classList.add('animated-post-image-bubble'); bubbleLink.setAttribute('aria-label', `Read more about ${escapedTitle}`); bubbleLink.title = escapedTitle; bubbleLink.style.width = `${bubbleSize}px`; bubbleLink.style.height = `${bubbleSize}px`; bubbleLink.style.zIndex = config.zIndex; bubbleLink.style.opacity = 0; const img = document.createElement('img'); img.src = post.image; img.alt = `Preview for ${escapedTitle}`; bubbleLink.appendChild(img); container.appendChild(bubbleLink); }); const imageBubbles = $$_PREV('#animated-images-container .animated-post-image-bubble'); if (typeof anime === 'function' && imageBubbles.length > 0) { imageBubbles.forEach((bubble) => { function fizzleAnimation() { const bubbleSize = parseFloat(bubble.style.width); const currentContainerHeight = container.offsetHeight > 0 ? container.offsetHeight : 600; const currentContainerWidth = container.offsetWidth > 0 ? container.offsetWidth : 300; const maxTop = Math.max(0, currentContainerHeight - bubbleSize - 10); const maxLeft = Math.max(0, currentContainerWidth - bubbleSize - 10); const newTop = anime.random(0, maxTop); const newLeft = anime.random(0, maxLeft); bubble.style.top = `${newTop}px`; bubble.style.left = `${newLeft}px`; bubble.style.transform = 'translateX(0px) translateY(0px)'; anime.timeline({ targets: bubble, easing: 'easeOutExpo', complete: fizzleAnimation }).add({ opacity: [0, 0.9], scale: [0.3, 1], duration: anime.random(700, 1000), }).add({ translateX: () => anime.random(-20, 20) + 'px', translateY: () => anime.random(-20, 20) + 'px', scale: () => anime.random(0.9, 1.1), duration: anime.random(3000, 5000), easing: 'easeInOutSine' }, '-=300') .add({ opacity: [bubble.style.opacity, 0], scale: [parseFloat(getComputedStyle(bubble).transform.split(',')[0].split('(')[1]) || 1, 0.2], duration: anime.random(600, 900), easing: 'easeInExpo', delay: anime.random(0, 400) }); } setTimeout(fizzleAnimation, anime.random(0, 2500)); }); } }); }
        async function loadAndRenderPosts_PREV() { try { const response = await fetch(APP_CONFIG_PREV.POSTS_JSON_PATH_PREV); if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}, path: ${APP_CONFIG_PREV.POSTS_JSON_PATH_PREV}`); } ALL_POSTS_DATA_PREV = await response.json(); ALL_POSTS_DATA_PREV.sort((a, b) => new Date(b.date) - new Date(a.date)); const writingsGrid = $_PREV('#writings-grid-container'); if (writingsGrid) { if (ALL_POSTS_DATA_PREV.length > 0) { writingsGrid.innerHTML = ALL_POSTS_DATA_PREV.map(post => createPostPreviewCard_PREV(post, false)).join(''); } else { writingsGrid.innerHTML = '<p class="text-text-subtle col-span-full text-center">No writings available.</p>'; } setupWritingsCardHoverEffects_PREV(); } const fullArticlesTarget = $_PREV('#full-articles-dynamic-content'); if (fullArticlesTarget) { fullArticlesTarget.innerHTML = ALL_POSTS_DATA_PREV.map(post => createFullArticleHtml_PREV(post)).join(''); } if (typeof setupHomePageRightColumnImages_PREV === 'function' && currentMainSection_PREV === 'home-content') { await setupHomePageRightColumnImages_PREV(); } } catch (error) { console.error("ERROR in loadAndRenderPosts:", error); if ($_PREV('#writings-grid-container')) $_PREV('#writings-grid-container').innerHTML = '<p class="text-text-subtle col-span-full text-center">Error: Could not load writings.</p>'; } }
        
        async function renderQuestionnaire_PREV() { const container = $_PREV('#questionnaire-render-area'); const calculateButton = $_PREV('#calculate-match-button'); const personalityMatchSection = $_PREV('#personality-match-section'); const contactTelegramBtn = $_PREV('#contact-telegram-btn'); if (!container || !calculateButton || !personalityMatchSection || !contactTelegramBtn) { if(container) container.innerHTML = '<p class="text-text-subtle text-center">Core UI elements missing.</p>'; return; } container.innerHTML = '<p class="text-center text-text-subtle">Loading questions...</p>'; try { console.log("Fetching:", APP_CONFIG_PREV.QUESTIONS_JSON_PATH_PREV); const response = await fetch(APP_CONFIG_PREV.QUESTIONS_JSON_PATH_PREV); if (!response.ok) { const errorText = await response.text(); console.error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}, path: ${APP_CONFIG_PREV.QUESTIONS_JSON_PATH_PREV}`); console.error("Response text:", errorText); throw new Error(`HTTP error! status: ${response.status} for ${APP_CONFIG_PREV.QUESTIONS_JSON_PATH_PREV}`); } ALL_QUESTIONNAIRE_DATA_PREV = await response.json(); console.log("Questions loaded:", ALL_QUESTIONNAIRE_DATA_PREV); } catch (error) { console.error("Error loading/parsing questionnaire data:", error); let userErrorMessage = "Error: Could not load questions. Check console."; if (error.message.includes("HTTP error")) { userErrorMessage = `Error: Could not fetch questions. Path: ${APP_CONFIG_PREV.QUESTIONS_JSON_PATH_PREV}`; } else if (error instanceof SyntaxError) { userErrorMessage = `Error: questions.json malformed. Path: ${APP_CONFIG_PREV.QUESTIONS_JSON_PATH_PREV}`; } container.innerHTML = `<p class="text-text-subtle text-center">${userErrorMessage}</p>`; return; } if (!Array.isArray(ALL_QUESTIONNAIRE_DATA_PREV) || ALL_QUESTIONNAIRE_DATA_PREV.length === 0) { container.innerHTML = '<p class="text-text-subtle text-center">No questions available or data format error.</p>'; return; } let html = ''; ALL_QUESTIONNAIRE_DATA_PREV.forEach((q) => { html += `<div class="question-block" id="question-${q.id}" data-question-id="${q.id}"><h3>${q.questionText}</h3><div class="answer-options">`; q.options.forEach((opt) => { const escapedOptionText = String(opt.text).replace(/"/g, '"'); html += `<button class="answer-option" data-option-text="${escapedOptionText}">${opt.text}</button>`; }); html += `</div><div class="feedback-area" id="feedback-${q.id}"></div></div>`; }); container.innerHTML = html; if (typeof anime === 'function') { anime({ targets: '.question-block', translateY: [30, 0], opacity: [0, 1], delay: anime.stagger(120, { start: 100 }), duration: 600, easing: 'easeOutExpo' }); } visitorAnswers_PREV = {}; questionsAnsweredCount_PREV = 0; personalityMatchSection.style.display = 'none'; personalityMatchSection.classList.remove('visible'); personalityMatchSection.style.opacity = '0'; personalityMatchSection.style.transform = 'translateY(20px)'; contactTelegramBtn.style.display = 'none'; calculateButton.style.display = 'none'; calculateButton.disabled = true; setupQuestionnaireInteractions_PREV(); }
        function setupQuestionnaireInteractions_PREV() { const answerOptionButtons = $$_PREV('#questionnaire-render-area .answer-option'); answerOptionButtons.forEach(button => { button.addEventListener('click', function() { const questionBlock = this.closest('.question-block'); if (questionBlock.classList.contains('answered')) return; const questionId = questionBlock.dataset.questionId; const selectedOptionText = this.dataset.optionText; const questionData = ALL_QUESTIONNAIRE_DATA_PREV.find(q => q.id === questionId); if (!questionData) return; const selectedOptionData = questionData.options.find(opt => opt.text === selectedOptionText); if (!selectedOptionData) return; questionBlock.classList.add('answered'); if (!visitorAnswers_PREV.hasOwnProperty(questionId)) questionsAnsweredCount_PREV++; visitorAnswers_PREV[questionId] = selectedOptionText; const optionsInBlock = questionBlock.querySelectorAll('.answer-option'); optionsInBlock.forEach(opt => { opt.disabled = true; opt.classList.remove('selected-visitor', 'selected-visitor-wrong', 'agraj-correct-answer'); if (opt !== this && opt.dataset.optionText !== questionData.agrajAnswerText && typeof anime === 'function') { anime({ targets: opt, opacity: 0.4, scale: 0.95, duration: 400, easing: 'easeOutQuad' }); } }); let animParams = { targets: this, duration: 400, easing: 'easeOutBack' }; if (selectedOptionText === questionData.agrajAnswerText) { this.classList.add('selected-visitor'); animParams.scale = [1, 1.05, 1]; } else { this.classList.add('selected-visitor-wrong'); const agrajAnswerButton = Array.from(optionsInBlock).find(optBtn => optBtn.dataset.optionText === questionData.agrajAnswerText); if (agrajAnswerButton) { agrajAnswerButton.classList.add('agraj-correct-answer'); if (typeof anime === 'function') { anime({ targets: agrajAnswerButton, scale: [1, 1.03, 1], duration: 400, delay:100, easing: 'easeOutBack' }); } } } if (typeof anime === 'function') anime(animParams); const feedbackArea = questionBlock.querySelector('.feedback-area'); feedbackArea.innerHTML = selectedOptionData.feedback; feedbackArea.classList.add('visible'); if (typeof anime === 'function') { anime({ targets: feedbackArea, opacity: [0, 1], translateY: [10,0], duration: 500, delay: 200, easing: 'easeOutExpo' }); } const calculateButton = $_PREV('#calculate-match-button'); if (ALL_QUESTIONNAIRE_DATA_PREV.length > 0 && questionsAnsweredCount_PREV === ALL_QUESTIONNAIRE_DATA_PREV.length) { calculateButton.style.display = 'inline-block'; calculateButton.disabled = false; if (typeof anime === 'function') { anime({ targets: calculateButton, opacity: [0, 1], scale: [0.8, 1], duration: 500, easing: 'easeOutExpo' }); } } else { calculateButton.style.display = 'none'; calculateButton.disabled = true; } }); }); const calculateButton = $_PREV('#calculate-match-button'); if (calculateButton) calculateButton.addEventListener('click', calculateAndShowMatch_PREV); }
        function calculateAndShowMatch_PREV() { const calcButton = $_PREV('#calculate-match-button'); if(calcButton) calcButton.disabled = true; if (ALL_QUESTIONNAIRE_DATA_PREV.length === 0 || questionsAnsweredCount_PREV < ALL_QUESTIONNAIRE_DATA_PREV.length) return; let matches = 0; ALL_QUESTIONNAIRE_DATA_PREV.forEach(qData => { const visitorSelectedText = visitorAnswers_PREV[qData.id]; if (visitorSelectedText && typeof visitorSelectedText === 'string' && typeof qData.agrajAnswerText === 'string' && visitorSelectedText.trim() === qData.agrajAnswerText.trim()) { matches++; } }); const totalQuestions = ALL_QUESTIONNAIRE_DATA_PREV.length; const percentage = totalQuestions > 0 ? Math.round((matches / totalQuestions) * 100) : 0; const percentageEl = $_PREV('#match-percentage-value'); const personalityMatchSection = $_PREV('#personality-match-section'); const contactTelegramBtn = $_PREV('#contact-telegram-btn'); if (!percentageEl || !personalityMatchSection || !contactTelegramBtn) return; percentageEl.textContent = percentage; percentageEl.style.opacity = '0'; percentageEl.style.transform = 'scale(0.5)'; if (revealSound_PREV && typeof revealSound_PREV.play === 'function') { revealSound_PREV.currentTime = 0; revealSound_PREV.play().catch(e => console.warn("Reveal sound play failed:", e)); } personalityMatchSection.style.display = 'block'; setTimeout(() => { if (typeof anime === 'function') { anime.timeline({ easing: 'easeOutExpo' }).add({ targets: personalityMatchSection, opacity: [0, 1], translateY: [30, 0], duration: 700, begin: () => personalityMatchSection.classList.add('visible') }).add({ targets: percentageEl, opacity: [0,1], scale: [0.5, 1.1, 1], duration: 800, }, '-=400') .add({ targets: [$_PREV('#personality-match-section h2'), $_PREV('#personality-match-section p'), $_PREV('#personality-match-section #mbti-type-value')], opacity: [0,1], translateY: [10,0], delay: anime.stagger(100), duration: 500 }, '-=500').finished.then(() => { personalityMatchSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); if (percentage >= APP_CONFIG_PREV.MATCH_THRESHOLD_FOR_CONTACT_PREV) { contactTelegramBtn.style.display = 'inline-block'; anime({targets: contactTelegramBtn, opacity: [0,1], scale: [0.8,1], duration: 500, easing: 'easeOutExpo'}); } else { contactTelegramBtn.style.display = 'none'; } }); } else { percentageEl.style.opacity = '1'; percentageEl.style.transform = 'scale(1)'; personalityMatchSection.style.opacity = '1'; personalityMatchSection.style.transform = 'translateY(0)'; personalityMatchSection.classList.add('visible'); personalityMatchSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); if (percentage >= APP_CONFIG_PREV.MATCH_THRESHOLD_FOR_CONTACT_PREV) { contactTelegramBtn.style.display = 'inline-block'; } else { contactTelegramBtn.style.display = 'none'; } } }, 50); }

        let matterEngine_PREV, matterRender_PREV, matterRunner_PREV; let gameShapes_PREV = []; const MAX_SHAPES_TO_SPAWN_PREV = 10; const SHAPES_TO_WIN_PREV = 3; let shapesSpawned_PREV = 0; let gameHasBeenWon_PREV = false; let targetZoneBody_PREV;
        function playSound_PREV(soundElement) { if (soundElement && typeof soundElement.play === 'function') { soundElement.currentTime = 0; soundElement.play().catch(e => console.warn("Game sound play failed:", e.message)); } }
        function resetSecretGame_PREV() { gameHasBeenWon_PREV = false; shapesSpawned_PREV = 0; if (matterEngine_PREV) Matter.Composite.clear(matterEngine_PREV.world, false); gameShapes_PREV = []; const canvas = $_PREV('#matter-canvas'); if (!canvas || !matterEngine_PREV) return; const canvasWidth = parseFloat(canvas.width); const canvasHeight = parseFloat(canvas.height); const ground = Matter.Bodies.rectangle(canvasWidth / 2, canvasHeight - 10, canvasWidth + 20, 60, { isStatic: true, render: { fillStyle: '#6a4a9a' } }); const leftWall = Matter.Bodies.rectangle(-30, canvasHeight / 2, 60, canvasHeight, { isStatic: true, render: { fillStyle: '#6a4a9a' } }); const rightWall = Matter.Bodies.rectangle(canvasWidth + 30, canvasHeight / 2, 60, canvasHeight, { isStatic: true, render: { fillStyle: '#6a4a9a' } }); const targetZoneHeight = 50; const targetZoneY = canvasHeight - 30 - (targetZoneHeight / 2) - 10; targetZoneBody_PREV = Matter.Bodies.rectangle(canvasWidth / 2, targetZoneY, canvasWidth * 0.5, targetZoneHeight, { isStatic: true, isSensor: true, label: 'targetZone', render: { fillStyle: 'rgba(174, 139, 213, 0.35)', strokeStyle: 'rgba(203, 184, 232, 0.6)', lineWidth: 2 } }); Matter.Composite.add(matterEngine_PREV.world, [ground, leftWall, rightWall, targetZoneBody_PREV]); updateGameInfoDisplay_PREV(); if ($_PREV('#game-win-message')) $_PREV('#game-win-message').textContent = "Drag shapes into the purple zone!"; }
        function updateGameInfoDisplay_PREV() { if ($_PREV('#game-shapes-dropped')) $_PREV('#game-shapes-dropped').textContent = shapesSpawned_PREV; if ($_PREV('#game-max-shapes')) $_PREV('#game-max-shapes').textContent = MAX_SHAPES_TO_SPAWN_PREV; let shapesInTargetCount = 0; if (targetZoneBody_PREV && gameShapes_PREV.length > 0) { gameShapes_PREV.forEach(shape => { if (Matter.Bounds.overlaps(shape.bounds, targetZoneBody_PREV.bounds) && shape.position.y > targetZoneBody_PREV.bounds.min.y && shape.position.y < targetZoneBody_PREV.bounds.max.y && Math.abs(shape.velocity.x) < 0.1 && Math.abs(shape.velocity.y) < 0.1) { shapesInTargetCount++; } }); } if ($_PREV('#game-shapes-in-target')) $_PREV('#game-shapes-in-target').textContent = shapesInTargetCount; if ($_PREV('#game-shapes-to-win')) $_PREV('#game-shapes-to-win').textContent = SHAPES_TO_WIN_PREV; const winMessageEl = $_PREV('#game-win-message'); if (winMessageEl) { if (!gameHasBeenWon_PREV && shapesInTargetCount >= SHAPES_TO_WIN_PREV) { gameHasBeenWon_PREV = true; winMessageEl.textContent = "YOU WIN! ✨"; playSound_PREV(gameWinSoundEl_PREV); if (typeof anime === 'function') { anime({ targets: winMessageEl, scale: [1, 1.2, 1], color: ['#AE8BD5', '#FFFFFF', '#AE8BD5'], duration: 1000, easing: 'easeInOutQuad' }); } } else if (!gameHasBeenWon_PREV && shapesSpawned_PREV >= MAX_SHAPES_TO_SPAWN_PREV && shapesInTargetCount < SHAPES_TO_WIN_PREV) { winMessageEl.textContent = "Out of shapes! Try again?"; } } }
        function setupSecretGame_PREV() { const trigger = $_PREV('#navbar-logo-image'); const modal = $_PREV('#secret-game-modal'); const canvas = $_PREV('#matter-canvas'); const closeButton = $_PREV('#close-game-button'); const resetButton = $_PREV('#reset-game-button'); if (!trigger || !modal || !canvas || !closeButton || !resetButton || typeof Matter === 'undefined') { if(trigger) trigger.style.display = 'none'; return; } const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, Bodies = Matter.Bodies, Composite = Matter.Composite, Mouse = Matter.Mouse, MouseConstraint = Matter.MouseConstraint, Events = Matter.Events; trigger.addEventListener('click', () => { modal.style.display = 'flex'; if (typeof anime === 'function') { anime({ targets: modal, opacity: [0,1], scale: [0.9, 1], duration: 400, easing: 'easeOutExpo' }); } if (matterRender_PREV) Matter.Render.stop(matterRender_PREV); if (matterRunner_PREV) Runner.stop(matterRunner_PREV); if (matterEngine_PREV) Matter.Engine.clear(matterEngine_PREV); if (canvas.firstChild && canvas.firstChild.tagName === 'CANVAS') { canvas.removeChild(canvas.firstChild); } matterEngine_PREV = Engine.create({ gravity: { y: 0.7 } }); let canvasWidth = Math.min(window.innerWidth * 0.85, 700); let canvasHeight = Math.min(window.innerHeight * 0.75, 450); canvas.width = canvasWidth; canvas.height = canvasHeight; matterRender_PREV = Render.create({ element: modal, canvas: canvas, engine: matterEngine_PREV, options: { width: canvasWidth, height: canvasHeight, wireframes: false, background: 'transparent' } }); resetSecretGame_PREV(); const mouse = Mouse.create(matterRender_PREV.canvas); const mouseConstraint = MouseConstraint.create(matterEngine_PREV, { mouse: mouse, constraint: { stiffness: 0.1, render: { visible: false } } }); Composite.add(matterEngine_PREV.world, mouseConstraint); matterRender_PREV.mouse = mouse; Events.on(mouseConstraint, 'mousedown', (event) => { if (gameHasBeenWon_PREV || shapesSpawned_PREV >= MAX_SHAPES_TO_SPAWN_PREV) return; const mousePosition = event.mouse.position; let body; const size = Math.random() * 20 + 15; const color = ['#CBB8E8', '#AE8BD5', '#FFFFFF', '#9272CE'][Math.floor(Math.random() * 4)]; if (shapesSpawned_PREV % 2 === 0) { body = Bodies.rectangle(mousePosition.x, mousePosition.y, size, size, { render: { fillStyle: color }, frictionAir: 0.03, restitution: 0.4 }); } else { body = Bodies.circle(mousePosition.x, mousePosition.y, size / 1.8, { render: { fillStyle: color }, frictionAir: 0.02, restitution: 0.6 }); } Composite.add(matterEngine_PREV.world, body); gameShapes_PREV.push(body); shapesSpawned_PREV++; playSound_PREV(gameSpawnSoundEl_PREV); updateGameInfoDisplay_PREV(); }); Events.on(matterEngine_PREV, 'afterUpdate', updateGameInfoDisplay_PREV); Render.run(matterRender_PREV); matterRunner_PREV = Runner.create(); Runner.run(matterRunner_PREV, matterEngine_PREV); }); closeButton.addEventListener('click', () => { if (typeof anime === 'function') { anime({ targets: modal, opacity: [1,0], scale: [1, 0.9], duration: 300, easing: 'easeInExpo', complete: () => modal.style.display = 'none' }); } else { modal.style.display = 'none'; } if (matterRender_PREV) Matter.Render.stop(matterRender_PREV); if (matterRunner_PREV) Runner.stop(matterRunner_PREV); if (matterEngine_PREV) Matter.Engine.clear(matterEngine_PREV); }); resetButton.addEventListener('click', resetSecretGame_PREV); }
        
        let rotatingTextInstances_PREV = {};
        function setupRotatingText_PREV(elementId, config) { 
            if (rotatingTextInstances_PREV[elementId]) { return; }
            const element = document.getElementById(elementId);
            if (!element) { console.warn(`Rotating text element not found: #${elementId}`); return; }
            let currentIndex = -1, isBusy = false, cycleTimeout = null;
            const runOnce = (elementId === 'typewriter' || config.texts.length === 1);
            element.textContent = ''; 
            function typeWriterInternal(text, callback) {
                let i = 0; isBusy = true;
                function type() {
                    if (!isBusy) { isBusy = false; return; }
                    if (i < text.length) { element.textContent += text.charAt(i); i++; setTimeout(type, config.typeSpeed); } 
                    else { const existingCursor = element.querySelector('.typed-cursor'); if (existingCursor) existingCursor.remove(); const cursor = document.createElement('span'); cursor.className = 'typed-cursor'; element.appendChild(cursor); isBusy = false; if (callback) callback(); }
                } type();
            }
            function deleteWriterInternal(callback) {
                if (runOnce && element.textContent.length > 0) { const existingCursor = element.querySelector('.typed-cursor'); if (!existingCursor) { const cursor = document.createElement('span'); cursor.className = 'typed-cursor'; element.appendChild(cursor); } if (callback) callback(); return; }
                let text = element.textContent; const existingCursor = element.querySelector('.typed-cursor'); if (existingCursor) existingCursor.remove(); text = element.textContent; let i = text.length; isBusy = true;
                function del() {
                     if (!isBusy) { isBusy = false; return; }
                    if (i > 0) { element.textContent = text.substring(0, i - 1); i--; if (!element.querySelector('.typed-cursor') && element.textContent.length > 0) { const cursor = document.createElement('span'); cursor.className = 'typed-cursor'; element.appendChild(cursor); } setTimeout(del, config.deleteSpeed); } 
                    else { const finalCursor = element.querySelector('.typed-cursor'); if (finalCursor) finalCursor.remove(); element.textContent = ''; isBusy = false; if (callback) callback(); }
                } del();
            }
            function scheduleCycle(delay) { if (runOnce) return; clearTimeout(cycleTimeout); cycleTimeout = setTimeout(startCycle, delay); }
            function startCycle() {
                if (runOnce || isBusy) return; 
                deleteWriterInternal(() => {
                    let nextIndex; do { nextIndex = Math.floor(Math.random() * config.texts.length); } while (nextIndex === currentIndex && config.texts.length > 1);
                    currentIndex = nextIndex; const nextText = config.texts[currentIndex];
                    element.textContent = ''; typeWriterInternal(nextText, () => scheduleCycle(config.pauseDuration));
                });
            }
            currentIndex = runOnce ? 0 : (elementId === 'main-heading-text' ? 0 : Math.floor(Math.random() * config.texts.length));
            const firstText = config.texts[currentIndex]; element.textContent = ''; 
            typeWriterInternal(firstText, () => { if (!runOnce) scheduleCycle(config.pauseDuration); });
        }
        
        function setupScrollProgressBar_PREV() { const progressBar = $_PREV("#progressBar"); if (!progressBar) return; window.addEventListener('scroll', () => { const winScroll = document.body.scrollTop || document.documentElement.scrollTop; const height = document.documentElement.scrollHeight - document.documentElement.clientHeight; const scrolled = height > 0 ? (winScroll / height) * 100 : 0; progressBar.style.width = scrolled + "%"; }, { passive: true }); }
        function setupWritingsCardHoverEffects_PREV() { $$_PREV('#writings-content .writing-preview-card').forEach(card => { card.addEventListener('mousemove', (e) => { const rect = card.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; const centerX = rect.width / 2; const centerY = rect.height / 2; const rotateX = (y - centerY) / 20; const rotateY = (centerX - x) / 20; card.style.transition = 'transform 0.1s ease-out'; card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateZ(20px)`; }); card.addEventListener('mouseleave', () => { card.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; card.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) translateZ(0px)'; }); card.querySelectorAll('a').forEach(link => { link.addEventListener('click', (e) => e.stopPropagation()); }); }); }
        
        let currentMainSection_PREV = null; let lastClickedReadMoreLink_PREV = null; 
        function showMainSection_PREV(sectionId) { 
            const previouslyActiveSection = $_PREV('.page-section.active-section');
            if (previouslyActiveSection) { previouslyActiveSection.classList.remove('active-section'); previouslyActiveSection.style.display = 'none'; }
            const targetSection = $_PREV(`#${sectionId}`);
            if (targetSection) {
                targetSection.style.display = 'block'; targetSection.classList.add('active-section'); currentMainSection_PREV = sectionId;
                $$_PREV('.site-navbar .navbar-links a').forEach(navLink => { navLink.classList.remove('active'); const navTarget = navLink.dataset.navlink; if ( (sectionId === 'home-content' && navTarget === 'home') || (sectionId === 'writings-content' && navTarget === 'writings') || (sectionId === 'about-content' && navTarget === 'about') ) { navLink.classList.add('active'); } });
                if (sectionId === 'about-content' && typeof renderQuestionnaire_PREV === 'function') { renderQuestionnaire_PREV(); } 
                else if (sectionId === 'home-content' && typeof setupHomePageRightColumnImages_PREV === 'function') { 
                    const existingBubbles = $$_PREV('#animated-images-container .animated-post-image-bubble');
                    if (existingBubbles.length === 0 && ALL_POSTS_DATA_PREV.length > 0) { setupHomePageRightColumnImages_PREV(); }
                }
                window.scrollTo({ top: 0, behavior: 'auto' });
            } else { console.warn(`Target section #${sectionId} not found.`); }
        }
        function handleMainRouteChange_PREV() { 
            let mainSectionTarget = 'home-content'; let articleDetailHash = '';
            const currentFullHash = window.location.hash;
            if (currentFullHash.startsWith('#post-')) { mainSectionTarget = 'writings-content'; articleDetailHash = currentFullHash; } 
            else if (currentFullHash === '#writings') { mainSectionTarget = 'writings-content'; } 
            else if (currentFullHash === '#about') { mainSectionTarget = 'about-content'; } 
            else if (currentFullHash === '#home' || currentFullHash === '' || currentFullHash === '#') {
                mainSectionTarget = 'home-content'; 
                if (currentFullHash === '' || currentFullHash === '#') {
                    if (window.history.replaceState) { window.history.replaceState(null, '', '#home'); } else { window.location.hash = '#home'; }
                }
            } else { 
                const isExternalNav = Array.from($$_PREV('.site-navbar .navbar-links a[target="_blank"]')).some(link => link.href.endsWith(currentFullHash) || `#${link.dataset.navlink}` === currentFullHash);
                if (!isExternalNav) { if (window.history.replaceState) { window.history.replaceState(null, '', '#home'); } else { window.location.hash = '#home'; } mainSectionTarget = 'home-content'; } 
                else { return; }
            }
            if (currentMainSection_PREV !== mainSectionTarget || mainSectionTarget === 'home-content' || (mainSectionTarget === 'writings-content' && articleDetailHash)) {
                 showMainSection_PREV(mainSectionTarget);
            }
            if (mainSectionTarget === 'writings-content' && typeof handleWritingsArticleLogic_PREV === 'function') { handleWritingsArticleLogic_PREV(articleDetailHash); document.title = articleDetailHash ? ($_PREV(`#${articleDetailHash.substring(1)} h2`)?.textContent + " - Writings") : APP_CONFIG_PREV.DEFAULT_TITLES_PREV.writings; } 
            else if (mainSectionTarget === 'about-content') { document.title = APP_CONFIG_PREV.DEFAULT_TITLES_PREV.about; } 
            else if (mainSectionTarget === 'home-content') { document.title = APP_CONFIG_PREV.DEFAULT_TITLES_PREV.home; }
        }
        function handleWritingsArticleLogic_PREV(articleHash) { const defaultWritingsTitle = APP_CONFIG_PREV.DEFAULT_TITLES_PREV.writings; if (articleHash && articleHash.startsWith('#post-')) { const targetId = articleHash.substring(1); const targetArticle = $_PREV(`#${targetId}`); if (targetArticle) { const titleElement = targetArticle.querySelector('h2'); const articleTitle = titleElement ? titleElement.textContent.trim() : "Article"; document.title = `${articleTitle} - Writings - Agraj Dubey`; if (currentMainSection_PREV !== 'writings-content') { showMainSection_PREV('writings-content'); } setTimeout(() => { if (!isElementInViewport_PREV(targetArticle)) targetArticle.scrollIntoView({ behavior: 'smooth', block: 'start' }); const heading = targetArticle.querySelector('h2'); if (heading) { heading.setAttribute('tabindex', '-1'); heading.focus({ preventScroll: true }); } }, 100); } else { document.title = defaultWritingsTitle; } } else { document.title = defaultWritingsTitle; const grid = $_PREV('#writings-grid-container'); if (grid && lastClickedReadMoreLink_PREV && document.body.contains(lastClickedReadMoreLink_PREV)) { setTimeout(() => { lastClickedReadMoreLink_PREV.focus({preventScroll: true}); if (!isElementInViewport_PREV(lastClickedReadMoreLink_PREV)) lastClickedReadMoreLink_PREV.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 50); } else if (grid) { setTimeout(() => { grid.setAttribute('tabindex', '-1'); grid.focus({preventScroll: true}); if (!isElementInViewport_PREV(grid)) grid.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50); } lastClickedReadMoreLink_PREV = null; } }
        function isElementInViewport_PREV(el) { if(!el) return false; const rect = el.getBoundingClientRect(); return (rect.top >= 0 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth)); }
        
        document.addEventListener('DOMContentLoaded', async () => {
            revealSound_PREV = $_PREV('#revealSound'); gameSpawnSoundEl_PREV = $_PREV('#gameSpawnSound'); gameWinSoundEl_PREV = $_PREV('#gameWinSound');
            if (typeof p5 !== 'undefined') { new p5(p5Sketch_PREV); } else { console.error("p5.js is not loaded!"); }
            setupScrollProgressBar_PREV();
            await loadAndRenderPosts_PREV(); 
            for (const elId in APP_CONFIG_PREV.ROTATING_TEXT_HOME) { if (document.getElementById(elId) && typeof setupRotatingText_PREV === 'function') { setupRotatingText_PREV(elId, APP_CONFIG_PREV.ROTATING_TEXT_HOME[elId]); } }
            document.body.addEventListener('click', function(event) { const clickedLink = event.target.closest('a.glitch-button[href^="#post-"], a.read-more-link[href^="#post-"]'); if (clickedLink) { lastClickedReadMoreLink_PREV = clickedLink; } });
            handleMainRouteChange_PREV();
            window.addEventListener('hashchange', handleMainRouteChange_PREV); 
            setupSecretGame_PREV(); 
            window.addEventListener('resize', () => { if (currentMainSection_PREV === 'home-content' && typeof setupHomePageRightColumnImages_PREV === 'function') { clearTimeout(window.resizeHomeImagesTimeout); window.resizeHomeImagesTimeout = setTimeout(setupHomePageRightColumnImages_PREV, 250); } });
        });
        // --- End of JS from previous functional state ---
    </script>
</body>
</html>
