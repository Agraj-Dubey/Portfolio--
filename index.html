<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>agraj - Portfolio</title>
    <link rel="icon" type="image/png" href="frieren.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhai+2:wght@700&family=Inter:wght@400;500;600;700&family=Lato:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;500;700&family=Nunito:wght@400;700&family=Fuzzy+Bubbles:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>


    <script>
        // Tailwind CSS configuration
        window.tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark': '#0f0a19', 'darker': '#090613', 'accent': '#9272CE',
                        'accent-hover': '#AE8BD5', 'light-accent': '#CBB8E8',
                        'text-primary': '#ffffff', 'text-secondary': '#D1D1D1', 'text-tertiary': '#A8A8A8',
                        'article-bg': 'rgba(20, 20, 22, 0.93)', 
                        'writings-card-bg': 'rgba(25, 15, 40, 0.88)',
                        'writings-card-hover-bg': 'rgba(45, 35, 60, 0.96)',
                        'dark-purple-bg': '#1a0a2e',
                        'hover-highlight': 'rgba(146, 114, 206, 0.1)',
                        'brand-purple': '#9272CE', 'brand-hover': '#AE8BD5',
                        'brand-light-purple': '#CBB8E8', 'brand-dark': '#050505',
                        'brand-light': '#FFFFFF', 'brand-gray': '#D1D1D1', 'brand-text': '#A8A8A8',
                        'correct-answer-bg': 'rgba(146, 114, 206, 0.35)', 
                        'selected-wrong-bg': 'rgba(100, 100, 100, 0.3)', 
                        'disabled-option-bg': 'rgba(30, 20, 50, 0.7)',
                    },
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'], serif: ['Baloo Bhai 2', 'cursive'],
                        lato: ['Lato', 'sans-serif'], outfit: ['Outfit', 'sans-serif'],
                        nunito: ['Nunito', 'sans-serif'], 'fuzzy-bubbles': ['Fuzzy Bubbles', 'cursive'],
                        verdana: ['Verdana', 'sans-serif'], 'trebuchet': ['Trebuchet MS', 'sans-serif'],
                    },
                }
            }
        };
    </script>

    <style>
        /* Basic Setup & Theming */
        html { scroll-behavior: smooth; }
        body {
            background-color: #0f0a19; color: #D1D1D1; font-family: 'Inter', sans-serif;
            overflow-x: hidden; line-height: 1.6; font-size: 16px;
        }
        #p5-background-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; }
        .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 30%, rgba(146, 114, 206, 0.03), rgba(15, 10, 25, 0.85) 70%); z-index: -5; pointer-events:none; }
        
        /* Page Section Transitions */
        .page-section { display: none; animation: fadeInPage 0.7s ease-out forwards; }
        .page-section.active-section { display: block; }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Typography */
        h1, h2, h3, h4, h5, h6 { color: #ffffff; font-weight: 700; }
        .font-serif { font-family: 'Baloo Bhai 2', cursive; }
        .font-outfit { font-family: 'Outfit', sans-serif; }
        .gradient-text { background: linear-gradient(90deg, #FFFFFF, #CBB8E8, #9272CE, #CBB8E8, #FFFFFF); background-size: 300% auto; background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientTextAnim 8s linear infinite; display: inline-block; }
        @keyframes gradientTextAnim { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* Typewriter Effect Cursor */
        .typed-cursor { display: inline-block; width: 2px; background-color: #9272CE; margin-left: 4px; animation: pulseCursor 1s infinite; vertical-align: text-bottom; }
        #home-content h1 .typed-cursor { height: 1em; background-color: #CBB8E8; }
        #home-content blockquote .typed-cursor { background-color: #A8A8A8; }
        #typewriter .typed-cursor { background-color: #D1D1D1; height: 1.1em;}
        #main-heading-text .typed-cursor { height: 1.1em; }
        #blockquote-text .typed-cursor { height: 1.1em; }
        @keyframes pulseCursor { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        #typewriter { min-height: 3em; display: inline-block; width: 100%; }
        #main-heading-text { min-height: 1.2em; display: inline-block; }
        #blockquote-text { min-height: 4em; display: inline-block; }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(9, 6, 19, 0.8); }
        ::-webkit-scrollbar-thumb { background: rgba(146, 114, 206, 0.5); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(146, 114, 206, 0.7); }

        /* Header and Navigation */
        .main-header { position: sticky; top: 0; left: 0; width: 100%; background-color: rgba(9, 6, 19, 0.85); backdrop-filter: blur(10px); z-index: 50; border-bottom: 1px solid rgba(146, 114, 206, 0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .main-header .nav-logo { font-family: 'Baloo Bhai 2', cursive; transition: color 0.3s ease; }
        .main-header .nav-logo:hover { color: #9272CE; }
        .desktop-nav a { position: relative; display: inline-block; transition: color 0.3s ease; }
        .desktop-nav a::after { content: ''; position: absolute; bottom: -3px; left: 0; width: 0; height: 1.5px; background-color: #9272CE; transition: width 0.3s ease; }
        .desktop-nav a:hover::after { width: 100%; }
        .desktop-nav a:hover, .desktop-nav a.active { color: #9272CE; }
        .desktop-nav a.active::after { width: 100%; }
        .nav-toggle-btn { background: none; border: none; padding: 0.5rem; cursor: pointer; z-index: 60; }
        .nav-toggle-btn svg { stroke: #ffffff; transition: stroke 0.3s ease; }
        .nav-toggle-btn:hover svg { stroke: #9272CE; }
        .nav-toggle-btn .burger-icon.hidden { display: none; }
        .nav-toggle-btn .close-icon.hidden { display: none; }
        .mobile-menu { display: none; position: absolute; top: 100%; left: 0; width: 100%; background-color: rgba(9, 6, 19, 0.95); backdrop-filter: blur(8px); padding: 1rem 0; box-shadow: 0 10px 20px rgba(0,0,0,0.4); z-index: 55; animation: slideDownFade 0.4s ease-out forwards; }
        .mobile-menu.is-open { display: block; }
        .mobile-menu a { display: block; padding: 0.8rem 1.5rem; font-size: 1.1rem; transition: color 0.3s ease, background-color 0.3s ease; text-align: center; }
        .mobile-menu a:hover { color: #9272CE; background-color: rgba(146, 114, 206, 0.1); }
        .mobile-menu a.active { background-color: rgba(146, 114, 206, 0.1); font-weight: 600; color: #9272CE; }
        @keyframes slideDownFade { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .desktop-nav a[target="_blank"]::after, .mobile-menu a[target="_blank"]::after { content: ' \2197'; font-size: 0.7em; vertical-align: super; display: inline-block; margin-left: 2px; opacity: 0.7; width: auto !important; height: auto !important; background: none !important; }
        
        /* Home Section Specific Styles */
        #heroSection { text-align: center; padding-top: 2.5rem; display: flex; flex-direction: column; justify-content: center; }
        #home-content .quote { position: relative; border-left: 3px solid #9272CE; margin-top: 1.5rem; } 
        #home-content .quote::before { content: '"'; position: absolute; top: -20px; left: 10px; font-size: 5rem; color: rgba(146, 114, 206, 0.1); font-family: 'Inter', sans-serif; font-weight: 700; }
        
        #home-content .card { 
            background: rgba(15, 10, 25, 0.75); 
            border: 1px solid rgba(146, 114, 206, 0.2);
            transition-property: box-shadow, border-color, transform;
            transition-duration: 0.4s;
            transition-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; /* Added for ::before */
            overflow: hidden;   /* Added for ::before */
        }
        #home-content .card::before { 
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(90deg, transparent, rgba(146, 114, 206, 0.1), transparent); 
            transform: translateX(-100%); 
            transition: transform 0.8s ease; 
            pointer-events: none; 
            z-index: 0; /* Consistency */
        }
        #home-content .card:hover { 
            box-shadow: 0 15px 30px rgba(9, 6, 19, 0.6), 0 0 20px rgba(146, 114, 206, 0.35); 
            border-color: rgba(146, 114, 206, 0.45); 
        }
        #home-content .card:hover::before { 
            transform: translateX(100%); 
        }

        .static-image-container { display: block; margin: 2.5rem auto 0 auto; width: fit-content; opacity: 0.8; transition: opacity 0.3s ease; z-index: 5; }
        .static-image { 
            width: 8rem; height: 8rem; cursor: pointer; 
            transition: transform 0.3s ease; 
            animation: subtleRingPulse 3s infinite ease-in-out;
        }
        @keyframes subtleRingPulse {
            0%, 100% { filter: drop-shadow(0 0 3px rgba(203, 184, 232, 0.3)); transform: scale(1); }
            50% { filter: drop-shadow(0 0 8px rgba(203, 184, 232, 0.5)); transform: scale(1.03); }
        }
        .static-image:hover { transform: scale(1.1); animation-play-state: paused; }

        #animated-images-container {
            position: relative;
            min-height: 700px; 
            margin-top: 1rem; 
        }
        .animated-post-image-bubble {
            position: absolute;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(146, 114, 206, 0.25), 0 0 8px rgba(0,0,0,0.3);
            border: 2px solid rgba(174, 139, 213, 0.3); 
            transition: border-color 0.3s ease;
            opacity: 0; /* Initial state for JS animation */
        }
        .animated-post-image-bubble:hover {
            border-color: rgba(174, 139, 213, 0.7); 
        }
        .animated-post-image-bubble img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }


        /* Writings Section Specific Styles */
        #writings-content { font-size: 17px; }
        #writings-content .text-hover-scale { transition: transform 0.25s ease-out; display: inline-block; }
        #writings-content .text-hover-scale:hover { transform: scale(1.03); }
        
        .writing-preview-card { 
            background-color: var(--card-bg, rgba(25, 15, 40, 0.9)); 
            backdrop-filter: blur(7px); 
            border-radius: 0.75rem; 
            padding: 2rem; 
            border: 1px solid rgba(146, 114, 206, 0.25); 
            display: flex; flex-direction: column; 
            transition: transform 0.3s ease-out, box-shadow 0.4s ease-out, border-color 0.4s ease-out, background-color 0.3s ease; 
            box-shadow: 0 6px 18px rgba(0,0,0, 0.35), 0 0 8px 1px rgba(146, 114, 206, 0.2);
            position: relative; /* ADDED for ::before */
            overflow: hidden;   /* ADDED for ::before */
        }
        .writing-preview-card::before { /* ADDED */
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(146, 114, 206, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.8s ease;
            pointer-events: none;
            z-index: 0; 
        }
        .writing-preview-card:hover { 
            transform: translateY(-10px) scale(1.03); /* Kept existing transform */
            background-color: var(--card-hover-bg, rgba(45, 35, 60, 0.97)); /* Kept existing background change */
            /* animation: cardGlowWritings 1.8s ease-in-out infinite alternate; */ /* REMOVED animation */
            box-shadow: 0 15px 30px rgba(9, 6, 19, 0.6), 0 0 20px rgba(146, 114, 206, 0.35); /* Matched home */
            border-color: rgba(146, 114, 206, 0.45); /* Matched home */
        }
        .writing-preview-card:hover::before { /* ADDED */
            transform: translateX(100%);
        }
        /* @keyframes cardGlowWritings REMOVED */

        .writing-preview-card h3 { color: #FFFFFF; font-size: 1.55rem; font-weight: 600; margin-bottom: 0.75rem; font-family: 'Outfit', sans-serif; }
        .writing-preview-card .post-meta-info { font-size: 0.9rem; color: #CBB8E8; margin-bottom: 1.25rem; font-family: 'Lato', sans-serif; opacity: 0.9; }
        .writing-preview-card .excerpt { color: #D1D1D1; font-size: 1.05rem; line-height: 1.65; flex-grow: 1; margin-bottom: 1.5rem; }
        .writing-preview-card a.read-more-link { display: inline-block; background: none; border: none; padding: 0; color: #9272CE; font-weight: 500; text-decoration: none; align-self: flex-start; cursor: pointer; transition: color 0.3s ease; font-size: 1.05rem; margin-top: auto; }
        .writing-preview-card a.read-more-link:hover { color: #AE8BD5; }
        
        /* Full Article View Styles */
        #full-articles-container { display: block; margin-top: 2rem; }
        #full-articles-container article { display: none; background-color: rgba(20, 20, 22, 0.94); backdrop-filter: blur(10px); border-radius: 0.75rem; padding: 2.5rem 2rem; margin-bottom: 3rem; box-shadow: 0 10px 40px rgba(0,0,0, 0.6), inset 0 1px 3px rgba(146, 114, 206, 0.1); border: 1px solid rgba(146, 114, 206, 0.3); border-top: 5px solid #9272CE; opacity: 0; }
        #full-articles-container article:target { display: block !important; opacity: 1 !important; animation: fadeInArticle 0.6s ease-out forwards; }
        @keyframes fadeInArticle { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #writings-grid-container:has(~ #full-articles-container article:target) { display: none; }
        hr.separator:has(~ #full-articles-container article:target) { display: none; }
        #full-articles-container h2 { color: #9272CE; margin-bottom: 0.75rem; font-size: 2.1rem; font-weight: 700; font-family: 'Outfit', sans-serif; line-height: 1.3; }
        #full-articles-container .post-meta-info { font-size: 0.95rem; color: #CBB8E8; margin-bottom: 2.5rem; font-family: 'Lato', sans-serif; opacity: 0.85; }
        a.back-button { display: inline-block; margin-top: 2.5rem; padding: 0.7rem 1.4rem; background-color: #9272CE; color: #FFFFFF; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; box-shadow: 0 3px 10px rgba(146, 114, 206, 0.2); font-size: 1rem; text-decoration: none; }
        a.back-button:hover { background-color: #AE8BD5; transform: scale(1.05) translateY(-2px); box-shadow: 0 8px 20px rgba(146, 114, 206, 0.3); }
        hr.separator { border: none; height: 2px; background-image: linear-gradient(to right, transparent, #9272CE, #AE8BD5, #9272CE, transparent); margin-top: 3rem; margin-bottom: 3rem; opacity: 0.6; display: block; }
        
        /* Article Content HTML Styling */
        .post-content-html { white-space: pre-line; text-align: left; line-height: 1.7; }
        .post-content-html p, .post-content-html blockquote, .post-content-html span, .post-content-html div, .post-content-html b, .post-content-html strong, .post-content-html i, .post-content-html em, .post-content-html u, .post-content-html a { font-family: inherit; font-size: 1.1rem; color: #D1D1D1; background-color: transparent !important; margin: 0 0 0.8em 0; font-weight: normal; font-style: normal; text-decoration: none; word-wrap: break-word; border-radius: 3px; }
        .post-content-html br { content: ""; display: block; margin-bottom: 0.1em; }
        .post-content-html span { margin: 0; display: inline; }
        .post-content-html [style*="font-family: Outfit"] { font-family: 'Outfit', sans-serif; } 
        .post-content-html [style*="font-family: Nunito"] { font-family: 'Nunito', sans-serif; } 
        .post-content-html [style*="font-family: Fuzzy Bubbles"] { font-family: 'Fuzzy Bubbles', cursive; } 
        .post-content-html [style*="font-family: verdana"] { font-family: 'Verdana', sans-serif; } 
        .post-content-html [style*="font-family: trebuchet"] { font-family: 'Trebuchet MS', sans-serif; }
        .post-content-html b, .post-content-html strong, .post-content-html [style*="font-weight: bold"] { font-weight: 700; } 
        .post-content-html i, .post-content-html em, .post-content-html [style*="font-style: italic"] { font-style: italic; } 
        .post-content-html u { text-decoration: underline; } 
        .post-content-html a { color: #9272CE; text-decoration: underline; transition: color 0.2s ease; display: inline; } 
        .post-content-html a:hover { color: #AE8BD5; }
        .post-content-html p[style*="text-align: center;"], .post-content-html div[style*="text-align: center;"], .post-content-html blockquote[style*="text-align: center;"] { text-align: center !important; margin-left: auto; margin-right: auto; }
        .post-content-html blockquote { border-left: 4px solid #9272CE; padding: 1em 1.75rem; margin-left: 0; margin-right: 0; font-style: italic; color: #A8A8A8; background-color: rgba(146, 114, 206, 0.05); }
        .post-content-html blockquote blockquote { margin-top: 1em; margin-left: 1.5rem; border-left-color: #AE8BD5; padding-left: 1rem; background-color: rgba(174, 139, 213, 0.05); }
        .post-content-html blockquote p { margin-bottom: 0.75em; }
        .post-content-html img { max-width: 100%; height: auto; display: block; margin: 2.5rem auto; border-radius: 0.75rem; box-shadow: 0 6px 20px rgba(0,0,0,0.4); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .post-content-html img:hover { transform: scale(1.03); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .post-content-html .separator { display: none; }
        
        @layer utilities { .line-clamp-3 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; } .line-clamp-4 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 4; } }
        
        /* Glitch Button and General Interactive Elements */
        .glitch-button { position: relative; display: inline-block; cursor: pointer; padding: 0.75rem 1.5rem; text-decoration: none; overflow: hidden; transition: transform 0.1s ease-out; -webkit-user-select: none; -ms-user-select: none; user-select: none; }
        .glitch-button .btn-text { position: relative; z-index: 1; }
        .glitch-button::before, .glitch-button::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: inherit; color: inherit; padding: inherit; overflow: hidden; transition: transform 0.3s cubic-bezier(0.75, 0, 0.25, 1), opacity 0.3s ease; opacity: 0; }
        .glitch-button:not(:disabled):hover::before { transform: translate(-3px, -2px) skewX(-5deg); text-shadow: 2px 0px #FF00FF; opacity: 0.8; animation: glitchEffectBefore 0.2s infinite alternate; }
        .glitch-button:not(:disabled):hover::after { transform: translate(3px, 2px) skewX(5deg); text-shadow: -2px 0px #00FFFF; opacity: 0.8; animation: glitchEffectAfter 0.2s infinite alternate-reverse; }
        .glitch-button:active { transform: scale(0.97); }
        @keyframes glitchEffectBefore { 0% { clip-path: inset(10% 0 70% 0); } 50% { clip-path: inset(40% 0 20% 0); } 100% { clip-path: inset(75% 0 5% 0); } }
        @keyframes glitchEffectAfter { 0% { clip-path: inset(60% 0 25% 0); } 50% { clip-path: inset(15% 0 55% 0); } 100% { clip-path: inset(50% 0 10% 0); } }
        #home-content .view-all-writings-btn { background-color: #9272CE; color: #FFFFFF; font-weight: 500; border-radius: 0.5rem; }
        #home-content .view-all-writings-btn:hover { background-color: #AE8BD5; }
        
        /* Footer, Progress Bar */
        .main-footer { background-color: rgba(9, 6, 19, 0.7); border-top: 1px solid rgba(146, 114, 206, 0.1); padding: 2rem 0; margin-top: 4rem; text-align: center; }
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 3px; z-index: 100; }
        .progress-bar { height: 3px; background: linear-gradient(90deg, #9272CE, #AE8BD5); width: 0%; }

        /* --- SECRET GAME STYLES --- */
        #secret-game-trigger { cursor: cell; display: inline-block; opacity: 0.5; transition: opacity 0.3s; }
        #secret-game-trigger:hover { opacity: 1; }
        #secret-game-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(9, 6, 19, 0.97); 
            backdrop-filter: blur(8px); 
            z-index: 1000; 
            display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
            animation: fadeInGameModal 0.5s ease-out forwards; 
        }
        @keyframes fadeInGameModal { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        #matter-canvas { 
            background-color: rgba(20, 15, 35, 0.6); 
            border: 2px solid rgba(146, 114, 206, 0.4); 
            border-radius: 8px; 
            box-shadow: 0 0 20px rgba(146, 114, 206, 0.2);
        }
        .game-controls { margin-top: 20px; display: flex; gap: 15px; }
        .game-controls button { 
            padding: 10px 20px; color: white; border: none; border-radius: 5px; 
            cursor: pointer; font-weight: 500; transition: background-color 0.3s, transform 0.2s;
            font-family: 'Outfit', sans-serif;
        }
        #close-game-button { background-color: #7c5bab; }
        #close-game-button:hover { background-color: #6a4a9a; transform: scale(1.05); }
        #reset-game-button { background-color: #5887a7; }
        #reset-game-button:hover { background-color: #4a7593; transform: scale(1.05); }
        #game-info {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 8px 15px; background-color: rgba(0,0,0,0.4); border-radius: 5px;
            color: #CBB8E8; font-size: 0.9rem; text-align: center; min-width: 250px; 
        }
        #game-info p { margin: 2px 0; }
        #game-win-message { font-weight: bold; color: #AE8BD5; }
        .game-instructions { color: #A8A8A8; font-size: 0.85rem; margin-top: 5px; }

        /* --- ABOUT SECTION STYLES (Questionnaire) --- */
        #about-content .questionnaire-container-wrapper { max-width: 850px; margin-left: auto; margin-right: auto; }
        .question-block { 
            background-color: rgba(28, 18, 52, 0.85); backdrop-filter: blur(8px); 
            border: 1px solid rgba(174, 139, 213, 0.35); border-radius: 1rem; 
            padding: 2.25rem 2.5rem; margin-bottom: 3.5rem; box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            min-height: 220px; display: flex; flex-direction: column;
            opacity: 0; transform: translateY(30px); 
        }
        .question-block h3 { color: #D7C2F2; font-size: 1.5rem; font-weight: 600; margin-bottom: 1.75rem; font-family: 'Outfit', sans-serif; }
        .answer-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.25rem; margin-bottom: 1.75rem; flex-grow: 1; }
        .answer-option {
            background-color: rgba(45, 30, 70, 0.8); color: #E0D8F0; 
            padding: 1rem 1.3rem; border-radius: 0.75rem; 
            border: 1px solid rgba(174, 139, 213, 0.45); cursor: pointer;
            transition: background-color 0.25s ease, border-color 0.25s ease, transform 0.2s ease-out, box-shadow 0.25s ease;
            text-align: left; font-size: 1.05rem; line-height: 1.4;
            opacity: 1; transform: scale(1);
        }
        .answer-option:not([disabled]):hover {
            background-color: rgba(174, 139, 213, 0.25); border-color: #AE8BD5; 
            transform: translateY(-4px) scale(1.035); box-shadow: 0 5px 15px rgba(174, 139, 213, 0.25);
        }
        .answer-option.selected-visitor { 
            background-color: #825FBD !important; color: #FFFFFF !important; 
            border-color: #CBB8E8 !important; font-weight: 700; 
            box-shadow: 0 0 18px rgba(146, 114, 206, 0.7);
        }
        .answer-option.selected-visitor-wrong { 
            background-color: var(--selected-wrong-bg, rgba(120, 120, 120, 0.45)) !important; 
            color: #D8D8D8 !important; border-color: var(--text-tertiary, #A8A8A8) !important;
            font-weight: 500; box-shadow: 0 0 8px rgba(120, 120, 120, 0.25);
        }
        .answer-option.agraj-correct-answer { 
            background-color: var(--correct-answer-bg, rgba(146, 114, 206, 0.55)) !important; 
            color: #FFFFFF !important; border-color: #CBB8E8 !important; 
            font-weight: 700; box-shadow: 0 0 15px rgba(174, 139, 213, 0.6);
        }
        .answer-option[disabled] {
            background-color: var(--disabled-option-bg, rgba(40, 30, 60, 0.75)) !important;
            color: #9a9a9a !important; cursor: not-allowed;
            border-color: rgba(146, 114, 206, 0.25) !important; opacity: 0.6; 
        }
        .answer-option[disabled]:not(.selected-visitor):not(.selected-visitor-wrong):not(.agraj-correct-answer) {
            opacity: 0.45; 
        }
        .feedback-area { margin-top: auto; padding: 1.35rem; background-color: rgba(15, 10, 30, 0.9); border-radius: 0.6rem; border-left: 5px solid #AE8BD5; color: #D7C2F2; font-size: 1rem; line-height: 1.65; display: none; animation: fadeInFeedback 0.6s ease-out forwards; }
        .feedback-area.visible { display: block; }
        @keyframes fadeInFeedback { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .feedback-area strong { color: #FFFFFF; font-weight: 700; }
        
        #personality-match-section { 
            margin-top: 4rem; padding: 2.75rem;  
            background-color: rgba(35, 25, 60, 0.9); backdrop-filter: blur(10px); 
            border-radius: 1rem; border: 1px solid rgba(174, 139, 213, 0.45); 
            text-align: center; box-shadow: 0 10px 35px rgba(0,0,0,0.4); 
        }
        #personality-match-section.visible {
            opacity: 1 !important; transform: translateY(0) !important; display: block !important; 
        }
        #personality-match-section h2 { color: #CBB8E8; font-size: 2.2rem; font-family: 'Outfit', sans-serif; margin-bottom: 2rem; }
        #personality-match-section p { font-size: 1.2rem; color: #E0D8F0; margin-bottom: 1.25rem; }
        #personality-match-section #match-percentage-value { 
            font-weight: 700; font-size: 3.5rem; color: #FFFFFF; 
            display: inline-block; margin: 0.5rem 0 1rem 0;
            padding: 0.3rem 0.8rem; border-radius: 0.5rem;
            background: linear-gradient(135deg, #AE8BD5, #9272CE);
            box-shadow: 0 4px 15px rgba(146, 114, 206, 0.4);
            opacity: 1; transform: scale(1);
        }
        #personality-match-section #mbti-type-value { font-weight: 600; color: #CBB8E8; font-size: 1.3rem; }
        #contact-telegram-btn {
            margin-top: 2rem; display: none; 
            background-color: #28A8EA; color: white;
            font-size: 1.1rem; padding: 0.9rem 1.8rem;
        }
        #contact-telegram-btn:hover { background-color: #229AC8; }
        
        #calculate-match-button { margin-top: 3rem; padding: 1rem 2.2rem; background-color: #9272CE; color: #FFFFFF; border: none; border-radius: 0.6rem; font-weight: 600; font-size: 1.15rem; }
         #calculate-match-button:disabled { background: #5a506b; color: #a8a8a8; cursor: not-allowed; opacity: 0.7; }
        #calculate-match-button:disabled::before,
        #calculate-match-button:disabled::after { display: none; }
    </style>
</head>
<body>
    <audio id="gameSpawnSound" src="spawn_sound.mp3" preload="auto"></audio>
    <audio id="gameWinSound" src="win_sound.mp3" preload="auto"></audio>
    <audio id="revealSound" src="reveal_sound.mp3" preload="auto"></audio>

    <div id="p5-background-canvas"></div>
    <div class="progress-container"> <div class="progress-bar" id="progressBar"></div> </div> 
    <div class="bg-overlay"></div>

    <header class="main-header"> 
        <div class="container mx-auto px-6 py-4"> 
            <div class="flex justify-between items-center"> 
                <a href="#home" class="nav-logo text-2xl lg:text-3xl font-bold text-text-primary">a-g-r-a-j</a> 
                <button id="nav-toggle" class="nav-toggle-btn md:hidden" aria-label="Toggle Menu" aria-expanded="false"> 
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" class="burger-icon"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" class="close-icon hidden"/>
                    </svg> 
                </button> 
                <nav class="desktop-nav hidden md:flex space-x-8 text-text-primary items-center"> 
                    <a href="#about" data-navlink="about">About Me</a> 
                    <a href="#writings" data-navlink="writings">Writings</a> 
                    <a href="https://www.reddit.com/user/Federal_Anywhere_559/" target="_blank" rel="noopener noreferrer" data-navlink="reddit">Reddit</a>
                    <a href="https://t.me/agraj0669" target="_blank" rel="noopener noreferrer" data-navlink="contact">Contact Me</a> 
                    <a href="#home" data-navlink="home" class="active">Home</a> 
                </nav> 
            </div> 
            <nav id="mobile-menu" class="mobile-menu md:hidden"> 
                <a href="#about" data-navlink="about">About Me</a> 
                <a href="#writings" data-navlink="writings">Writings</a> 
                <a href="https://www.reddit.com/user/Federal_Anywhere_559/" target="_blank" rel="noopener noreferrer" data-navlink="reddit">Reddit</a>
                <a href="https://t.me/agraj0669" target="_blank" rel="noopener noreferrer" data-navlink="contact">Contact Me</a> 
                <a href="#home" data-navlink="home" class="active">Home</a> 
            </nav> 
        </div> 
    </header>
    
    <div id="page-container">
        <section id="home-content" class="page-section"> 
            <main class="container mx-auto px-4 md:px-6 pt-16 md:pt-24 pb-16">
                <div class="flex flex-col md:flex-row gap-x-8 lg:gap-x-12">
                    <!-- Left Column -->
                    <div class="md:w-2/3 lg:w-[60%]">
                        <section class="opacity-0" id="heroSection">  
                            <div id="home-hero-text-content" class="w-full"> 
                                <h1 class="gradient-text text-5xl md:text-6xl lg:text-7xl font-bold mb-6 tracking-tight font-serif"> 
                                    <span id="main-heading-text"></span> 
                                </h1> 
                                <p class="text-xl md:text-2xl text-text-secondary mb-10 md:mb-12 italic" id="typewriter"></p> 
                                <blockquote class="quote max-w-xl mx-auto text-lg md:text-xl bg-darker/80 backdrop-blur-sm p-6 rounded-lg shadow-xl text-text-tertiary border-l-4 border-accent"> 
                                    "<span id="blockquote-text"></span>" 
                                </blockquote> 
                            </div> 
                        </section> 
                        <section class="mb-16 opacity-0" id="writingsSectionHome"> 
                            <h2 class="text-3xl md:text-4xl font-bold text-center text-text-primary mt-16 mb-12">Recent Writings</h2> 
                            <div class="grid grid-cols-1 gap-8" id="home-recent-writings-grid"></div> 
                            <div class="text-center mt-12 md:mt-16"> 
                                <a href="#writings" class="view-all-writings-btn glitch-button" data-text="View All Writings"> 
                                    <span class="btn-text">View All Writings</span> 
                                </a> 
                            </div> 
                            <div id="staticImageContainerHome" class="static-image-container"> 
                                <img src="FrierenRing.png" alt="Frieren's Ring image (interactive)" id="staticImageHome" class="static-image"> 
                            </div> 
                        </section> 
                    </div>
                    <!-- Right Column -->
                    <div class="md:w-1/3 lg:w-[40%]">
                        <section id="home-animated-post-images" class="sticky top-24 hidden md:block mt-8 md:mt-0 pl-4">
                            <div id="animated-images-container">
                            </div>
                        </section>
                    </div>
                </div>
            </main> 
        </section>
        
        <section id="writings-content" class="page-section"> 
            <main class="container mx-auto px-6 py-16 md:py-20 min-h-screen"> 
                <div class="text-center mb-12 md:mb-16 pt-8"> 
                    <h1 class="text-4xl md:text-5xl font-bold text-text-primary font-outfit">My Writings</h1> 
                </div> 
                <section id="writings-grid-container" class="mb-12 md:mb-20 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8"></section> 
                <hr class="separator"> 
                <section id="full-articles-container"> 
                    <div class="full-articles-content max-w-4xl mx-auto" id="full-articles-dynamic-content"></div> 
                </section> 
            </main> 
        </section>

        <section id="about-content" class="page-section">
            <main class="container mx-auto px-6 py-16 md:py-20 min-h-screen">
                <div class="text-center mb-12 md:mb-16 pt-8">
                    <h1 class="text-4xl md:text-5xl font-bold text-text-primary font-outfit">A Little More About Me</h1>
                    <p class="text-text-secondary mt-4 text-lg">Answer these questions to see how our perspectives align (or amusingly diverge!).</p>
                </div>
                <div id="questionnaire-container-wrapper" class="questionnaire-container-wrapper">
                    <div id="questionnaire-render-area">
                        <p class="text-center text-text-secondary">Loading questions...</p>
                    </div>
                    <div id="personality-match-section" class="mt-12" style="display: none; opacity: 0; transform: translateY(20px);">
                        <h2>Personality Snapshot</h2>
                        <p>Your alignment with my perspectives: <span id="match-percentage-value">0</span>%</p>
                        <p>My MBTI Type: <span id="mbti-type-value">INFJ</span></p>
                        <p class="text-sm text-text-tertiary mt-4">Note: This is a simplified alignment based on these specific questions.</p>
                        <a href="https://t.me/agraj0669" target="_blank" rel="noopener noreferrer" id="contact-telegram-btn" class="glitch-button mt-6" data-text="Contact on Telegram!">
                            <span class="btn-text">Contact on Telegram!</span>
                        </a>
                    </div>
                    <div class="text-center">
                         <button id="calculate-match-button" class="glitch-button" data-text="See How We Match!" style="display: none;"><span class="btn-text">See How We Match!</span></button>
                    </div>
                </div>
            </main>
        </section>
    </div>

    <footer class="main-footer relative z-10"> 
        <div class="container mx-auto px-6"> 
            <p class="text-text-tertiary">© <span id="currentYear"></span> agraj. All rights reserved. <span id="secret-game-trigger" title="Feeling lucky?">🕹️</span> </p> 
        </div> 
    </footer>
    
    <div id="secret-game-modal">
        <div id="game-info">
            <p>Shapes dropped: <span id="game-shapes-dropped">0</span>/<span id="game-max-shapes">0</span></p>
            <p>In target: <span id="game-shapes-in-target">0</span>/<span id="game-shapes-to-win">0</span></p>
            <p id="game-win-message" class="game-instructions">Drag shapes into the purple zone!</p>
        </div>
        <canvas id="matter-canvas"></canvas>
        <div class="game-controls">
            <button id="reset-game-button" class="glitch-button" data-text="Reset Game"><span class="btn-text">Reset Game</span></button>
            <button id="close-game-button" class="glitch-button" data-text="Close Game"><span class="btn-text">Close Game</span></button>
        </div>
    </div>

    <script>
        const APP_CONFIG = {
             ROTATING_TEXT_HOME: { 
                 'typewriter': { texts: ["Cause no one listens, so I write instead 😎"], typeSpeed: 80, deleteSpeed: 50, pauseDuration: 3000 },
                 'main-heading-text': { texts: ["agraj", "アグラジ", "अग्रज", "αγραξ"], typeSpeed: 100, deleteSpeed: 60, pauseDuration: 2500 },
                 'blockquote-text': { 
                     texts: [
                        "The stream ran bright, water paving away, tap dancing with sunlight.",
                        "Was I born different? What did I do different that made me the way I am?",
                        "Time flies by; for me it does so in gloom. Worries of the future, regrets of the past.",
                        "If a book doesn't change you, even in the slightest, it isn't worth reading.",
                        "All went away for nothing, and all I am now is who I was never supposed to be.",
                        "What remains now is foreign—stranger even to myself."
                     ], 
                     typeSpeed: 70, deleteSpeed: 40, pauseDuration: 4500 
                 }
            },
            DEFAULT_TITLES: { 
                home: "agraj - Portfolio",
                writings: "Writings - Agraj Dubey",
                about: "About Me - Agraj Dubey"
            },
            POSTS_JSON_PATH: 'posts.json',
            QUESTIONS_JSON_PATH: 'questions.json',
            TELEGRAM_USERNAME: 'agraj0669',
            MATCH_THRESHOLD_FOR_CONTACT: 70
        };
        
        let ALL_QUESTIONNAIRE_DATA = [];
        let visitorAnswers = {}; 
        let questionsAnsweredCount = 0;
        let revealSound, gameSpawnSoundEl, gameWinSoundEl;

        function $(selector) { return document.querySelector(selector); }
        function $$(selector) { return document.querySelectorAll(selector); }

        // --- p5.js Generative Background (Reverted to Abstract Blobs) ---
        let p5Blobs = [];
        const NUM_P5_BLOBS = 5; 

        function p5Sketch(p) {
            class Blob {
                constructor() {
                    this.x = p.random(p.width);
                    this.y = p.random(p.height);
                    this.r = p.random(p.width / 3.5, p.width / 1.3); 
                    this.xSpeed = p.random(-0.35, 0.35); 
                    this.ySpeed = p.random(-0.35, 0.35); 
                    this.numPoints = p.int(p.random(6, 12));
                    this.noiseSeedX = p.random(1000);
                    this.noiseSeedY = p.random(1000);
                    this.noiseSeedR = p.random(1000); 
                    this.hue = p.random(230, 310); 
                    this.hueShiftSpeed = p.random(-0.12, 0.12); 
                    this.opacity = p.random(4, 10); 
                }

                update() {
                    this.x += this.xSpeed + (p.noise(this.noiseSeedX + p.frameCount * 0.0005) - 0.5) * 0.5; 
                    this.y += this.ySpeed + (p.noise(this.noiseSeedY + p.frameCount * 0.0005) - 0.5) * 0.5; 
                    this.r = p.map(p.noise(this.noiseSeedR + p.frameCount * 0.0012), 0, 1, p.width / 4.5, p.width / 1.1); 

                    if (this.x < -this.r * 1.5) this.x = p.width + this.r * 1.5;
                    if (this.x > p.width + this.r * 1.5) this.x = -this.r * 1.5;
                    if (this.y < -this.r * 1.5) this.y = p.height + this.r * 1.5;
                    if (this.y > p.height + this.r * 1.5) this.y = -this.r * 1.5;
                    
                    this.hue = (this.hue + this.hueShiftSpeed + 360) % 360;
                }

                display() {
                    p.fill(this.hue, 60, 70, this.opacity); 
                    p.beginShape();
                    let angleStep = p.TWO_PI / this.numPoints;
                    for (let i = 0; i <= this.numPoints; i++) { 
                        let angle = i * angleStep;
                        let radiusOffset = p.map(p.noise(this.noiseSeedX + i * 0.2 + p.frameCount * 0.002, this.noiseSeedY + i * 0.2), 0, 1, -this.r * 0.4, this.r * 0.4);
                        let currentR = this.r + radiusOffset;
                        let vx = this.x + currentR * p.cos(angle);
                        let vy = this.y + currentR * p.sin(angle);
                        p.curveVertex(vx, vy);
                         if (i === 0 || i === 1 || i === this.numPoints-1 || i === this.numPoints) { 
                            p.curveVertex(vx, vy);
                        }
                    }
                    p.endShape();
                }
            }

            p.setup = function() {
                const p5CanvasContainer = $('#p5-background-canvas');
                if (!p5CanvasContainer) { console.error("p5 canvas container not found!"); return; }
                const p5Renderer = p.createCanvas(p.windowWidth, p.windowHeight);
                p5Renderer.parent(p5CanvasContainer); 
                p.colorMode(p.HSB, 360, 100, 100, 100);
                p.noStroke();
                for (let i = 0; i < NUM_P5_BLOBS; i++) { p5Blobs.push(new Blob()); }
            };

            p.draw = function() {
                p.clear(); 
                for (let blob of p5Blobs) {
                    blob.update();
                    blob.display();
                }
            };

            p.windowResized = function() {
                p.resizeCanvas(p.windowWidth, p.windowHeight);
                p5Blobs = [];
                for (let i = 0; i < NUM_P5_BLOBS; i++) { p5Blobs.push(new Blob()); }
            };
        }
        // --- End p5.js Generative Background ---

        // --- Content Rendering (Writings) ---
        let ALL_POST_DATA_FOR_HOME_RECENT = []; let ALL_POSTS_DATA = [];
        function simpleMarkdownToHtml(md) {
            if (typeof md !== 'string') return ''; let html = md;
            if (html.startsWith('`') && html.endsWith('`') && !html.startsWith('```') && !html.endsWith('```')) { html = html.substring(1, html.length - 1); }
            html = html.replace(/<br\s*\/?>/gi, '[[BR_TAG]]'); html = html.replace(/\n/g, '[[BR_TAG]]');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');    
            html = html.replace(/\\\"/g, '"'); html = html.replace(/\[\[BR_TAG\]\]/g, '<br>\n');
            html = html.replace(/(<br>\n\s*){2,}/gi, '<br>\n'); return html;
        }
        function createPostPreviewCard(post, isForHome = false) { 
            const cardClass = isForHome ? 'card' : 'writing-preview-card';
            const delayForInitialAnim = isForHome && ALL_POST_DATA_FOR_HOME_RECENT.length > 0 ? (ALL_POST_DATA_FOR_HOME_RECENT.indexOf(post) * 150) : 0;
            
            const anchorClass = `glitch-button ${isForHome ? 'text-accent hover:text-accent-hover font-medium inline-flex items-center' : 'read-more-link'}`;
            const readMoreTextContent = `Read More ${!isForHome ? '→' : ''}`;
            const arrowSvg = isForHome ? ' <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>' : '';
            const dataText = readMoreTextContent.trim();

            return `
                <div class="${cardClass} rounded-lg p-7 shadow-lg relative overflow-hidden" ${isForHome ? `data-initial-anim-delay="${delayForInitialAnim}"` : ''}>
                    <h3 class="text-xl lg:text-2xl font-semibold text-text-primary mb-4 group ${!isForHome ? 'text-hover-scale font-outfit' : ''}">
                        <span class="${isForHome ? 'hover:text-accent' : ''} transition-all duration-300 inline-block">${post.title}</span>
                    </h3>
                    ${!isForHome ? `<div class="post-meta-info">${new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>` : ''}
                    <div class="mb-5"><p class="text-text-secondary line-clamp-${isForHome ? 3 : 4} ${!isForHome ? 'excerpt' : ''}">${post.excerpt}</p></div>
                    <a href="#${post.id}" class="${anchorClass}" data-text="${dataText}">
                        <span class="btn-text">${readMoreTextContent}${arrowSvg}</span>
                    </a>
                </div>
            `;
        }
        function createFullArticleHtml(post) { 
            const htmlContent = simpleMarkdownToHtml(post.contentMarkdown); 
            return `
                <article id="${post.id}" tabindex="-1">
                    <h2 class="text-hover-scale">${post.title}</h2>
                    <div class="post-meta-info">Published: ${new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                    ${post.image ? `<img src="${post.image}" alt="${post.imageAlt || post.title}" class="my-8 rounded-lg shadow-lg mx-auto max-w-full md:max-w-2xl" loading="lazy">` : ''}
                    <div class="post-content-html">${htmlContent}</div>
                    <a href="#writings" class="back-button mt-8 glitch-button" data-text="← Back to Writings"><span class="btn-text">← Back to Writings</span></a>
                </article>
            `;
        }

        // --- Home Page Right Column Animated Image Bubbles (Fizzling Effect) ---
        async function setupHomePageRightColumnImages() {
            const container = $('#animated-images-container');
            const sectionContainer = $('#home-animated-post-images');

            if (!container || !sectionContainer) { console.warn("Animated images container not ready."); return; }
            if (ALL_POSTS_DATA.length === 0) { setTimeout(setupHomePageRightColumnImages, 200); return; }

            const postsWithImages = ALL_POSTS_DATA.filter(post => post.image).slice(0, 4);
            if (postsWithImages.length === 0) {
                container.innerHTML = '<p class="text-text-tertiary text-sm text-center md:text-left">No recent visual entries.</p>';
                return;
            }
            
            container.innerHTML = ''; 

            const bubbleConfigs = [ // Increased sizes
                { sizeVW: 14, minSize: 130, maxSize: 220, zIndex: 1 }, 
                { sizeVW: 12, minSize: 120, maxSize: 190, zIndex: 3 },
                { sizeVW: 15, minSize: 140, maxSize: 230, zIndex: 2 },
                { sizeVW: 13, minSize: 125, maxSize: 200, zIndex: 1 }
            ];
            
            // Defer dimension calculation slightly
            requestAnimationFrame(() => {
                const containerWidth = container.offsetWidth;
                const containerHeight = container.offsetHeight;

                if (containerWidth === 0 || containerHeight === 0) {
                    console.warn("Animated images container has no dimensions yet. Retrying or using defaults.");
                    // Fallback or retry logic can be added here if necessary
                }

                postsWithImages.forEach((post, index) => {
                    if (index >= bubbleConfigs.length) return; 
                    const config = bubbleConfigs[index];
                    const escapedTitle = post.title.replace(/"/g, '"');
                    
                    let bubbleSize = Math.max(config.minSize, Math.min(config.maxSize, window.innerWidth * (config.sizeVW / 100)));
                    bubbleSize = Math.min(bubbleSize, (containerWidth > 0 ? containerWidth * 0.9 : config.maxSize), (containerHeight > 0 ? containerHeight * 0.45 : config.maxSize));

                    const bubbleLink = document.createElement('a');
                    bubbleLink.href = `#${post.id}`;
                    bubbleLink.classList.add('animated-post-image-bubble');
                    bubbleLink.setAttribute('aria-label', `Read more about ${escapedTitle}`);
                    bubbleLink.title = escapedTitle;
                    
                    bubbleLink.style.width = `${bubbleSize}px`;
                    bubbleLink.style.height = `${bubbleSize}px`;
                    bubbleLink.style.zIndex = config.zIndex;
                    bubbleLink.style.opacity = 0; 

                    const img = document.createElement('img');
                    img.src = post.image;
                    img.alt = `Preview for ${escapedTitle}`;
                    
                    bubbleLink.appendChild(img);
                    container.appendChild(bubbleLink);
                });

                const imageBubbles = $$('#animated-images-container .animated-post-image-bubble');
                if (typeof anime === 'function' && imageBubbles.length > 0) {
                    imageBubbles.forEach((bubble) => {
                        function fizzleAnimation() {
                            const bubbleSize = parseFloat(bubble.style.width);
                            // Ensure container dimensions are positive before calculating maxTop/maxLeft
                            const currentContainerHeight = container.offsetHeight > 0 ? container.offsetHeight : 600; // Fallback height
                            const currentContainerWidth = container.offsetWidth > 0 ? container.offsetWidth : 300; // Fallback width

                            const maxTop = Math.max(0, currentContainerHeight - bubbleSize - 10); 
                            const maxLeft = Math.max(0, currentContainerWidth - bubbleSize - 10);

                            const newTop = anime.random(0, maxTop);
                            const newLeft = anime.random(0, maxLeft);
                            
                            bubble.style.top = `${newTop}px`;
                            bubble.style.left = `${newLeft}px`;
                            bubble.style.transform = 'translateX(0px) translateY(0px)';

                            anime.timeline({
                                targets: bubble,
                                easing: 'easeOutExpo', 
                                complete: fizzleAnimation 
                            })
                            .add({ 
                                opacity: [0, 0.9], 
                                scale: [0.3, 1],
                                duration: anime.random(500, 800),
                            })
                            .add({ 
                                translateX: () => anime.random(-15, 15) + 'px',
                                translateY: () => anime.random(-15, 15) + 'px',
                                scale: () => anime.random(0.95, 1.05), 
                                duration: anime.random(2500, 4500), 
                                easing: 'easeInOutSine'
                            }, '-=200') 
                            .add({ 
                                opacity: [bubble.style.opacity, 0], // Use current opacity for smoother transition from drift
                                scale: [parseFloat(getComputedStyle(bubble).transform.split(',')[0].split('(')[1]) || 1, 0.2], // Get current scale
                                duration: anime.random(400, 700),
                                easing: 'easeInExpo', 
                                delay: anime.random(0, 300) 
                            });
                        }
                        setTimeout(fizzleAnimation, anime.random(0, 2000)); 
                    });
                }
            }); // End of requestAnimationFrame
        }


        async function loadAndRenderPosts() { 
            console.log("Attempting to load posts from:", APP_CONFIG.POSTS_JSON_PATH);
            try {
                const response = await fetch(APP_CONFIG.POSTS_JSON_PATH);
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}, path: ${APP_CONFIG.POSTS_JSON_PATH}`); }
                ALL_POSTS_DATA = await response.json();
                ALL_POSTS_DATA.sort((a, b) => new Date(b.date) - new Date(a.date)); 
                ALL_POST_DATA_FOR_HOME_RECENT = ALL_POSTS_DATA.slice(0, 3); 
                
                const homeGrid = $('#home-recent-writings-grid');
                if (homeGrid) {
                    if (ALL_POST_DATA_FOR_HOME_RECENT.length > 0) { homeGrid.innerHTML = ALL_POST_DATA_FOR_HOME_RECENT.map(post => createPostPreviewCard(post, true)).join(''); } 
                    else { homeGrid.innerHTML = '<p class="text-text-secondary col-span-full text-center">No recent writings to display.</p>'; }
                    setupHomeCardHoverEffects(); 
                }
                const writingsGrid = $('#writings-grid-container');
                if (writingsGrid) {
                     if (ALL_POSTS_DATA.length > 0) { writingsGrid.innerHTML = ALL_POSTS_DATA.map(post => createPostPreviewCard(post, false)).join(''); } 
                     else { writingsGrid.innerHTML = '<p class="text-text-secondary col-span-full text-center">No writings available.</p>'; }
                }
                const fullArticlesTarget = $('#full-articles-dynamic-content');
                 if (fullArticlesTarget) {  fullArticlesTarget.innerHTML = ALL_POSTS_DATA.map(post => createFullArticleHtml(post)).join(''); }

                if (typeof setupHomePageRightColumnImages === 'function') {
                    await setupHomePageRightColumnImages(); 
                }
                setupHomeScrollAnimations();

            } catch (error) {
                console.error("ERROR in loadAndRenderPosts:", error);
                if ($('#home-recent-writings-grid')) $('#home-recent-writings-grid').innerHTML = '<p class="text-text-secondary col-span-full text-center">Error: Could not load recent writings.</p>';
                if ($('#writings-grid-container')) $('#writings-grid-container').innerHTML = '<p class="text-text-secondary col-span-full text-center">Error: Could not load writings.</p>';
            }
        }

        // --- Questionnaire Logic --- (Unchanged)
        async function renderQuestionnaire() {
            const container = $('#questionnaire-render-area');
            const calculateButton = $('#calculate-match-button');
            const personalityMatchSection = $('#personality-match-section');
            const contactTelegramBtn = $('#contact-telegram-btn');

            if (!container || !calculateButton || !personalityMatchSection || !contactTelegramBtn) {
                console.error("One or more questionnaire UI elements not found. Aborting render.");
                if(container) container.innerHTML = '<p class="text-text-secondary text-center">Core UI elements missing for questionnaire.</p>';
                return;
            }
            container.innerHTML = '<p class="text-center text-text-secondary">Loading questions...</p>'; 

            try {
                const response = await fetch(APP_CONFIG.QUESTIONS_JSON_PATH);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${APP_CONFIG.QUESTIONS_JSON_PATH}`);
                ALL_QUESTIONNAIRE_DATA = await response.json();
            } catch (error) {
                console.error("Error loading questionnaire data:", error);
                container.innerHTML = `<p class="text-text-secondary text-center">Error: Could not load questions. (${error.message})</p>`;
                return;
            }
            
            if (ALL_QUESTIONNAIRE_DATA.length === 0) {
                container.innerHTML = '<p class="text-text-secondary text-center">No questions available at the moment.</p>';
                return;
            }

            let html = '';
            ALL_QUESTIONNAIRE_DATA.forEach((q) => {
                html += `
                    <div class="question-block" id="question-${q.id}" data-question-id="${q.id}">
                        <h3>${q.questionText}</h3>
                        <div class="answer-options">
                `;
                q.options.forEach((opt) => {
                    const escapedOptionText = String(opt.text).replace(/"/g, '"');
                    html += `<button class="answer-option" data-option-text="${escapedOptionText}">${opt.text}</button>`;
                });
                html += `
                        </div>
                        <div class="feedback-area" id="feedback-${q.id}"></div>
                    </div>
                `;
            });
            container.innerHTML = html;
            
            if (typeof anime === 'function') {
                anime({
                    targets: '.question-block', translateY: [30, 0], opacity: [0, 1],
                    delay: anime.stagger(120, { start: 100 }), duration: 600, easing: 'easeOutExpo'
                });
            }
            
            visitorAnswers = {}; 
            questionsAnsweredCount = 0; 

            personalityMatchSection.style.display = 'none'; 
            personalityMatchSection.classList.remove('visible');
            personalityMatchSection.style.opacity = '0';
            personalityMatchSection.style.transform = 'translateY(20px)';
            contactTelegramBtn.style.display = 'none';
            calculateButton.style.display = 'none'; 
            calculateButton.disabled = true;

            setupQuestionnaireInteractions();
        }
        function setupQuestionnaireInteractions() {
            const answerOptionButtons = $$('#questionnaire-render-area .answer-option');
            answerOptionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const questionBlock = this.closest('.question-block');
                    if (questionBlock.classList.contains('answered')) return;
                    const questionId = questionBlock.dataset.questionId;
                    const selectedOptionText = this.dataset.optionText;
                    const questionData = ALL_QUESTIONNAIRE_DATA.find(q => q.id === questionId);
                    if (!questionData) return;
                    const selectedOptionData = questionData.options.find(opt => opt.text === selectedOptionText);
                    if (!selectedOptionData) return;
                    questionBlock.classList.add('answered'); 
                    if (!visitorAnswers.hasOwnProperty(questionId)) questionsAnsweredCount++;
                    visitorAnswers[questionId] = selectedOptionText; 
                    const optionsInBlock = questionBlock.querySelectorAll('.answer-option');
                    optionsInBlock.forEach(opt => {
                        opt.disabled = true;
                        opt.classList.remove('selected-visitor', 'selected-visitor-wrong', 'agraj-correct-answer'); 
                        if (opt !== this && opt.dataset.optionText !== questionData.agrajAnswerText && typeof anime === 'function') {
                            anime({ targets: opt, opacity: 0.4, scale: 0.95, duration: 400, easing: 'easeOutQuad' });
                        }
                    });
                    let animParams = { targets: this, duration: 400, easing: 'easeOutBack' };
                    if (selectedOptionText === questionData.agrajAnswerText) {
                        this.classList.add('selected-visitor');
                        animParams.scale = [1, 1.05, 1]; 
                        animParams.backgroundColor = '#825FBD'; 
                    } else {
                        this.classList.add('selected-visitor-wrong');
                        animParams.backgroundColor = tailwind.theme.extend.colors['selected-wrong-bg'] || 'rgba(120,120,120,0.45)';
                        const agrajAnswerButton = Array.from(optionsInBlock).find(optBtn => optBtn.dataset.optionText === questionData.agrajAnswerText);
                        if (agrajAnswerButton) {
                            agrajAnswerButton.classList.add('agraj-correct-answer');
                             if (typeof anime === 'function') {
                                anime({ targets: agrajAnswerButton, scale: [1, 1.03, 1], backgroundColor: tailwind.theme.extend.colors['correct-answer-bg'] || 'rgba(146,114,206,0.55)', duration: 400, delay:100, easing: 'easeOutBack' });
                            }
                        }
                    }
                    if (typeof anime === 'function') anime(animParams); 
                    const feedbackArea = questionBlock.querySelector('.feedback-area');
                    feedbackArea.innerHTML = selectedOptionData.feedback; 
                    feedbackArea.classList.add('visible');
                     if (typeof anime === 'function') { 
                        anime({ targets: feedbackArea, opacity: [0, 1], translateY: [10,0], duration: 500, delay: 200, easing: 'easeOutExpo' });
                    }
                    const calculateButton = $('#calculate-match-button');
                    if (ALL_QUESTIONNAIRE_DATA.length > 0 && questionsAnsweredCount === ALL_QUESTIONNAIRE_DATA.length) {
                        calculateButton.style.display = 'inline-block';
                        calculateButton.disabled = false;
                         if (typeof anime === 'function') {
                            anime({ targets: calculateButton, opacity: [0, 1], scale: [0.8, 1], duration: 500, easing: 'easeOutExpo' });
                        }
                    } else {
                        calculateButton.style.display = 'none';
                        calculateButton.disabled = true;
                    }
                });
            });
            const calculateButton = $('#calculate-match-button');
            if (calculateButton) calculateButton.addEventListener('click', calculateAndShowMatch);
        }
        function calculateAndShowMatch() {
            const calcButton = $('#calculate-match-button'); 
            if(calcButton) calcButton.disabled = true; 
            if (ALL_QUESTIONNAIRE_DATA.length === 0 || questionsAnsweredCount < ALL_QUESTIONNAIRE_DATA.length) return;
            let matches = 0;
            ALL_QUESTIONNAIRE_DATA.forEach(qData => {
                const visitorSelectedText = visitorAnswers[qData.id];
                if (visitorSelectedText && typeof visitorSelectedText === 'string' && typeof qData.agrajAnswerText === 'string' && 
                    visitorSelectedText.trim() === qData.agrajAnswerText.trim()) {
                    matches++;
                }
            });
            const totalQuestions = ALL_QUESTIONNAIRE_DATA.length;
            const percentage = totalQuestions > 0 ? Math.round((matches / totalQuestions) * 100) : 0;
            const percentageEl = $('#match-percentage-value');
            const personalityMatchSection = $('#personality-match-section');
            const contactTelegramBtn = $('#contact-telegram-btn');
            if (!percentageEl || !personalityMatchSection || !contactTelegramBtn) return;
            percentageEl.textContent = percentage; 
            percentageEl.style.opacity = '0'; 
            percentageEl.style.transform = 'scale(0.5)';
            if (revealSound && typeof revealSound.play === 'function') {
                revealSound.currentTime = 0; 
                revealSound.play().catch(e => console.warn("Reveal sound play failed:", e));
            }
            personalityMatchSection.style.display = 'block'; 
            setTimeout(() => { 
                if (typeof anime === 'function') {
                    anime.timeline({ easing: 'easeOutExpo' })
                    .add({
                        targets: personalityMatchSection,
                        opacity: [0, 1], translateY: [30, 0], duration: 700,
                        begin: () => personalityMatchSection.classList.add('visible')
                    })
                    .add({
                        targets: percentageEl, opacity: [0,1], scale: [0.5, 1.1, 1], duration: 800,
                    }, '-=400') 
                    .add({
                        targets: [$('#personality-match-section h2'), $('#personality-match-section p'), $('#personality-match-section #mbti-type-value')],
                        opacity: [0,1], translateY: [10,0], delay: anime.stagger(100), duration: 500
                    }, '-=500')
                    .finished.then(() => {
                        personalityMatchSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        if (percentage >= APP_CONFIG.MATCH_THRESHOLD_FOR_CONTACT) {
                            contactTelegramBtn.style.display = 'inline-block'; 
                            anime({targets: contactTelegramBtn, opacity: [0,1], scale: [0.8,1], duration: 500, easing: 'easeOutExpo'});
                        } else {
                            contactTelegramBtn.style.display = 'none';
                        }
                    });
                } else { 
                    percentageEl.style.opacity = '1'; percentageEl.style.transform = 'scale(1)';
                    personalityMatchSection.style.opacity = '1'; personalityMatchSection.style.transform = 'translateY(0)';
                    personalityMatchSection.classList.add('visible');
                    personalityMatchSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (percentage >= APP_CONFIG.MATCH_THRESHOLD_FOR_CONTACT) {
                        contactTelegramBtn.style.display = 'inline-block';
                    } else {
                        contactTelegramBtn.style.display = 'none';
                    }
                }
            }, 50);
        }

        // --- Secret Game Logic --- (Unchanged)
        let matterEngine, matterRender, matterRunner;
        let gameShapes = [];
        const MAX_SHAPES_TO_SPAWN = 10; const SHAPES_TO_WIN = 3;
        let shapesSpawned = 0; let gameHasBeenWon = false; let targetZoneBody;
        function playSound(soundElement) {
            if (soundElement && typeof soundElement.play === 'function') {
                soundElement.currentTime = 0;
                soundElement.play().catch(e => console.warn("Game sound play failed:", e.message));
            }
        }
        function resetSecretGame() {
            console.log("Resetting secret game...");
            gameHasBeenWon = false; shapesSpawned = 0;
            if (matterEngine) Matter.Composite.clear(matterEngine.world, false); 
            gameShapes = [];
            const canvas = $('#matter-canvas');
            if (!canvas || !matterEngine) return;
            const canvasWidth = parseFloat(canvas.width); const canvasHeight = parseFloat(canvas.height);
            const ground = Matter.Bodies.rectangle(canvasWidth / 2, canvasHeight - 10, canvasWidth + 20, 60, { isStatic: true, render: { fillStyle: '#6a4a9a' } });
            const leftWall = Matter.Bodies.rectangle(-30, canvasHeight / 2, 60, canvasHeight, { isStatic: true, render: { fillStyle: '#6a4a9a' } });
            const rightWall = Matter.Bodies.rectangle(canvasWidth + 30, canvasHeight / 2, 60, canvasHeight, { isStatic: true, render: { fillStyle: '#6a4a9a' } });
            const targetZoneHeight = 50;
            const targetZoneY = canvasHeight - 30 - (targetZoneHeight / 2) - 10;
            targetZoneBody = Matter.Bodies.rectangle(canvasWidth / 2, targetZoneY, canvasWidth * 0.5, targetZoneHeight, {
                isStatic: true, isSensor: true, label: 'targetZone',
                render: { fillStyle: 'rgba(174, 139, 213, 0.35)', strokeStyle: 'rgba(203, 184, 232, 0.6)', lineWidth: 2 }
            });
            Matter.Composite.add(matterEngine.world, [ground, leftWall, rightWall, targetZoneBody]);
            updateGameInfoDisplay();
            if ($('#game-win-message')) $('#game-win-message').textContent = "Drag shapes into the purple zone!";
        }
        function updateGameInfoDisplay() {
            if ($('#game-shapes-dropped')) $('#game-shapes-dropped').textContent = shapesSpawned;
            if ($('#game-max-shapes')) $('#game-max-shapes').textContent = MAX_SHAPES_TO_SPAWN;
            let shapesInTargetCount = 0;
            if (targetZoneBody && gameShapes.length > 0) {
                gameShapes.forEach(shape => {
                    if (Matter.Bounds.overlaps(shape.bounds, targetZoneBody.bounds) && 
                        shape.position.y > targetZoneBody.bounds.min.y && 
                        shape.position.y < targetZoneBody.bounds.max.y &&
                        Math.abs(shape.velocity.x) < 0.1 && Math.abs(shape.velocity.y) < 0.1) { 
                        shapesInTargetCount++;
                    }
                });
            }
            if ($('#game-shapes-in-target')) $('#game-shapes-in-target').textContent = shapesInTargetCount;
            if ($('#game-shapes-to-win')) $('#game-shapes-to-win').textContent = SHAPES_TO_WIN;
            const winMessageEl = $('#game-win-message');
            if (winMessageEl) {
                if (!gameHasBeenWon && shapesInTargetCount >= SHAPES_TO_WIN) {
                    gameHasBeenWon = true; winMessageEl.textContent = "YOU WIN! ✨"; playSound(gameWinSoundEl);
                    if (typeof anime === 'function') { anime({ targets: winMessageEl, scale: [1, 1.2, 1], color: ['#AE8BD5', '#FFFFFF', '#AE8BD5'], duration: 1000, easing: 'easeInOutQuad' }); }
                } else if (!gameHasBeenWon && shapesSpawned >= MAX_SHAPES_TO_SPAWN && shapesInTargetCount < SHAPES_TO_WIN) {
                     winMessageEl.textContent = "Out of shapes! Try again?";
                }
            }
        }
        function setupSecretGame() {
            const trigger = $('#secret-game-trigger'); const modal = $('#secret-game-modal'); 
            const canvas = $('#matter-canvas'); const closeButton = $('#close-game-button');
            const resetButton = $('#reset-game-button');
            if (!trigger || !modal || !canvas || !closeButton || !resetButton || typeof Matter === 'undefined') { 
                if(trigger) trigger.style.display = 'none'; 
                console.warn("Secret game elements not found or Matter.js missing. Game disabled."); return; 
            }
            const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, 
                  Bodies = Matter.Bodies, Composite = Matter.Composite, Mouse = Matter.Mouse, 
                  MouseConstraint = Matter.MouseConstraint, Events = Matter.Events;
            trigger.addEventListener('click', () => {
                modal.style.display = 'flex';
                if (typeof anime === 'function') { anime({ targets: modal, opacity: [0,1], scale: [0.9, 1], duration: 400, easing: 'easeOutExpo' }); }
                if (matterRender) Matter.Render.stop(matterRender); 
                if (matterRunner) Runner.stop(matterRunner);
                if (matterEngine) Matter.Engine.clear(matterEngine); 
                if (canvas.firstChild && canvas.firstChild.tagName === 'CANVAS') { canvas.removeChild(canvas.firstChild); }
                matterEngine = Engine.create({ gravity: { y: 0.7 } });
                let canvasWidth = Math.min(window.innerWidth * 0.85, 700); 
                let canvasHeight = Math.min(window.innerHeight * 0.75, 450);
                canvas.width = canvasWidth; canvas.height = canvasHeight;
                matterRender = Render.create({ 
                    element: modal, canvas: canvas, engine: matterEngine, 
                    options: { width: canvasWidth, height: canvasHeight, wireframes: false, background: 'transparent' } 
                });
                resetSecretGame();
                const mouse = Mouse.create(matterRender.canvas); 
                const mouseConstraint = MouseConstraint.create(matterEngine, { 
                    mouse: mouse, constraint: { stiffness: 0.1, render: { visible: false } } 
                });
                Composite.add(matterEngine.world, mouseConstraint); matterRender.mouse = mouse;
                Events.on(mouseConstraint, 'mousedown', (event) => {
                    if (gameHasBeenWon || shapesSpawned >= MAX_SHAPES_TO_SPAWN) return;
                    const mousePosition = event.mouse.position; let body;
                    const size = Math.random() * 20 + 15;
                    const color = ['#CBB8E8', '#AE8BD5', '#FFFFFF', '#9272CE'][Math.floor(Math.random() * 4)];
                    if (shapesSpawned % 2 === 0) { 
                        body = Bodies.rectangle(mousePosition.x, mousePosition.y, size, size, { render: { fillStyle: color }, frictionAir: 0.03, restitution: 0.4 });
                    } else {
                        body = Bodies.circle(mousePosition.x, mousePosition.y, size / 1.8, { render: { fillStyle: color }, frictionAir: 0.02, restitution: 0.6 });
                    }
                    Composite.add(matterEngine.world, body); gameShapes.push(body);
                    shapesSpawned++; playSound(gameSpawnSoundEl); updateGameInfoDisplay();
                });
                Events.on(matterEngine, 'afterUpdate', updateGameInfoDisplay);
                Render.run(matterRender); matterRunner = Runner.create(); Runner.run(matterRunner, matterEngine);
            });
            closeButton.addEventListener('click', () => { 
                if (typeof anime === 'function') {
                    anime({
                        targets: modal, opacity: [1,0], scale: [1, 0.9], duration: 300, easing: 'easeInExpo',
                        complete: () => modal.style.display = 'none'
                    });
                } else { modal.style.display = 'none'; }
                if (matterRender) Matter.Render.stop(matterRender); if (matterRunner) Runner.stop(matterRunner);
                if (matterEngine) Matter.Engine.clear(matterEngine); 
            });
            resetButton.addEventListener('click', resetSecretGame);
        }

        // --- Other JS functions (Routing, Utils, etc.) --- 
        let rotatingTextInstances = {};
        function setupRotatingText(elementId, config) { 
            if (rotatingTextInstances[elementId]) { return; }
            const element = document.getElementById(elementId);
            if (!element) { console.warn(`Rotating text element not found: #${elementId}`); return; }
            let currentIndex = -1, isBusy = false, cycleTimeout = null, isVisible = false;
            const runOnce = (elementId === 'typewriter');
            element.textContent = ''; 
            function typeWriterInternal(text, callback) {
                let i = 0; isBusy = true;
                function type() {
                    if (!isVisible || !isBusy) { isBusy = false; if (!isVisible) element.textContent = ''; return; }
                    if (i < text.length) {
                        element.textContent += text.charAt(i); i++;
                        setTimeout(type, config.typeSpeed);
                    } else {
                        if (element.querySelector('.typed-cursor')) element.removeChild(element.querySelector('.typed-cursor'));
                        const cursor = document.createElement('span'); cursor.className = 'typed-cursor'; element.appendChild(cursor);
                        isBusy = false; if (callback) callback();
                    }
                } type();
            }
            function deleteWriterInternal(callback) {
                if (runOnce && element.textContent.length > 0) { if (callback) callback(); return; }
                let text = element.textContent;
                const existingCursor = element.querySelector('.typed-cursor');
                if (existingCursor) element.removeChild(existingCursor);
                text = element.textContent; 
                let i = text.length; isBusy = true;
                function del() {
                    if (!isVisible || !isBusy) { isBusy = false; if (!isVisible) element.textContent = ''; return; }
                    if (i > 0) {
                        element.textContent = text.substring(0, i - 1); i--;
                        if (!element.querySelector('.typed-cursor') && element.textContent.length > 0) {
                           const cursor = document.createElement('span'); cursor.className = 'typed-cursor'; element.appendChild(cursor);
                        } setTimeout(del, config.deleteSpeed);
                    } else {
                        const finalCursor = element.querySelector('.typed-cursor'); if (finalCursor) element.removeChild(finalCursor);
                        element.textContent = ''; isBusy = false; if (callback) callback();
                    }
                } del();
            }
            function scheduleCycle(delay) { if (runOnce) return; clearTimeout(cycleTimeout); cycleTimeout = setTimeout(() => { if(isVisible) startCycle(); }, delay); }
            function startCycle() {
                if (runOnce || isBusy || !isVisible) return;
                deleteWriterInternal(() => {
                    if (!isVisible) return; let nextIndex;
                    do { nextIndex = Math.floor(Math.random() * config.texts.length); }
                    while (nextIndex === currentIndex && config.texts.length > 1);
                    currentIndex = nextIndex; const nextText = config.texts[currentIndex];
                    element.textContent = ''; typeWriterInternal(nextText, () => scheduleCycle(config.pauseDuration));
                });
            }
            let initialized = false;
            const intersectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const wasVisible = isVisible; isVisible = entry.isIntersecting;
                    if (isVisible && !wasVisible) {
                        if (!initialized) {
                            initialized = true;
                            currentIndex = runOnce ? 0 : (elementId === 'main-heading-text' ? 0 : Math.floor(Math.random() * config.texts.length));
                            const firstText = config.texts[currentIndex];
                            element.textContent = ''; typeWriterInternal(firstText, () => { if (!runOnce) scheduleCycle(config.pauseDuration); });
                        } else { 
                            if (!isBusy) {
                                if (runOnce) { if(element.textContent === '') { element.textContent = ''; typeWriterInternal(config.texts[0], () => {}); }
                                } else { element.textContent = ''; scheduleCycle(100); }
                            }
                        }
                    } else if (!isVisible && wasVisible) { clearTimeout(cycleTimeout); isBusy = false; }
                });
            }, { threshold: 0.1 });
            intersectionObserver.observe(element);
            rotatingTextInstances[elementId] = { observer: intersectionObserver, element: element };
        }

        function setupMobileMenu() { 
            const navToggle = $('#nav-toggle'); 
            const mobileMenu = $('#mobile-menu');
            if (navToggle && mobileMenu) {
                const burgerIcon = navToggle.querySelector('.burger-icon');
                const closeIcon = navToggle.querySelector('.close-icon');

                navToggle.addEventListener('click', () => { 
                    const isOpen = mobileMenu.classList.toggle('is-open'); 
                    navToggle.setAttribute('aria-expanded', String(isOpen)); 
                    if (burgerIcon && closeIcon) {
                        burgerIcon.classList.toggle('hidden', isOpen);
                        closeIcon.classList.toggle('hidden', !isOpen);
                    }
                });
                $$('#mobile-menu a').forEach(link => { 
                    link.addEventListener('click', () => { 
                        mobileMenu.classList.remove('is-open'); 
                        navToggle.setAttribute('aria-expanded', 'false'); 
                        if (burgerIcon && closeIcon) {
                            burgerIcon.classList.remove('hidden');
                            closeIcon.classList.add('hidden');
                        }
                    }); 
                });
            }
        }

        function setupScrollProgressBar() { 
            const progressBar = $("#progressBar"); if (!progressBar) return;
            window.addEventListener('scroll', () => { const winScroll = document.body.scrollTop || document.documentElement.scrollTop; const height = document.documentElement.scrollHeight - document.documentElement.clientHeight; const scrolled = height > 0 ? (winScroll / height) * 100 : 0; progressBar.style.width = scrolled + "%"; }, { passive: true });
        }
        function setupStaticImageClick() {
            const imageElement = $('#staticImageHome'); if (!imageElement) return;
            const videoUrls = [ 'https://www.youtube.com/watch?v=dQw4w9WgXcQ', 'https://www.youtube.com/watch?v=-jGBp5HBLFs', 'https://www.youtube.com/shorts/2Dv2hO3rYVg', 'https://www.youtube.com/watch?v=x6YcdgB9e48', 'https://www.youtube.com/shorts/D-kkjR0NyGg', 'https://www.youtube.com/shorts/LFsS-9lT0Rk', 'https://www.youtube.com/shorts/TTU1g8IU22I' ];
            imageElement.addEventListener('click', () => { const randomIndex = Math.floor(Math.random() * videoUrls.length); window.open(videoUrls[randomIndex], '_blank'); });
        }
        
        function setupHomeCardHoverEffects() { 
             $$('#home-content .card').forEach(card => {
                card.addEventListener('mousemove', (e) => { 
                    const rect = card.getBoundingClientRect(); 
                    const x = e.clientX - rect.left; 
                    const y = e.clientY - rect.top; 
                    const centerX = rect.width / 2; 
                    const centerY = rect.height / 2; 
                    const rotateX = (y - centerY) / 20; 
                    const rotateY = (centerX - x) / 20; 
                    card.style.transition = 'transform 0.1s ease-out'; 
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateZ(20px)`; 
                });
                card.addEventListener('mouseleave', () => { 
                    card.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; 
                    card.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) translateZ(0px)'; 
                });
                card.querySelectorAll('a').forEach(link => { link.addEventListener('click', (e) => e.stopPropagation()); });
            });
        }

        function setupHomeScrollAnimations() { 
             const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -30px 0px' };
             const observer = new IntersectionObserver((entries, obs) => {
                 entries.forEach(entry => {
                     const isRotatingText = Object.keys(APP_CONFIG.ROTATING_TEXT_HOME).includes(entry.target.id);
                     if (entry.isIntersecting) { 
                        if (!isRotatingText) { 
                            entry.target.style.opacity = '1'; 
                            entry.target.style.transform = entry.target.dataset.initialTransform || 'translateY(0)'; 
                            
                            if (entry.target.classList.contains('card') && entry.target.closest('#home-recent-writings-grid')) {
                                const delay = parseInt(entry.target.getAttribute('data-initial-anim-delay')) || 0;
                                const initialAnimDuration = 800; 
                                setTimeout(() => {
                                    entry.target.style.transitionProperty = 'box-shadow, border-color, transform'; 
                                }, initialAnimDuration + delay + 50); 
                            }
                            obs.unobserve(entry.target); 
                        } 
                    }
                 });
             }, observerOptions);
            
             const heroSection = $('#heroSection'); 
             if (heroSection) { 
                heroSection.style.opacity = '0'; 
                heroSection.style.transform = 'translateY(20px)'; 
                heroSection.dataset.initialTransform = 'translateY(0)'; 
                heroSection.style.transition = 'opacity 0.8s ease-out, transform 0.8s ease-out'; 
                observer.observe(heroSection); 
            }
             const writingsSectionHome = $('#writingsSectionHome'); 
             if (writingsSectionHome) { 
                writingsSectionHome.style.opacity = '0'; 
                writingsSectionHome.style.transform = 'translateY(20px)'; 
                writingsSectionHome.dataset.initialTransform = 'translateY(0)'; 
                writingsSectionHome.style.transition = 'opacity 0.8s ease-out, transform 0.8s ease-out'; 
                observer.observe(writingsSectionHome); 
            }
             
             $$('#home-content .card').forEach(card => { 
                 const delay = parseInt(card.getAttribute('data-initial-anim-delay')) || 0; 
                 card.style.opacity = '0'; 
                 card.style.transform = 'perspective(1000px) rotateX(10deg) rotateY(10deg) translateZ(-20px)'; 
                 card.dataset.initialTransform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) translateZ(0px)'; 
                 card.style.transition = `opacity 0.8s ease-out ${delay}ms, transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${delay}ms`;
                 observer.observe(card);
             });

             const homeAnimatedImagesSection = $('#home-animated-post-images');
             if(homeAnimatedImagesSection) {
                homeAnimatedImagesSection.style.opacity = '0'; 
                homeAnimatedImagesSection.style.transform = 'translateX(30px)'; 
                homeAnimatedImagesSection.dataset.initialTransform = 'translateX(0px)';
                homeAnimatedImagesSection.style.transition = 'opacity 0.8s ease-out 0.4s, transform 0.8s ease-out 0.4s'; 
                observer.observe(homeAnimatedImagesSection);
             }
        }
        
        let currentMainSection = null;
        let lastClickedReadMoreLink = null; 

        function showMainSection(sectionId) { 
            const previouslyActiveSection = $('.page-section.active-section');
            if (previouslyActiveSection) previouslyActiveSection.classList.remove('active-section');
            const targetSection = $(`#${sectionId}`);
            if (targetSection) {
                targetSection.classList.add('active-section');
                currentMainSection = sectionId;
                $$('.desktop-nav a, .mobile-menu a').forEach(navLink => {
                    navLink.classList.remove('active');
                    const navTarget = navLink.dataset.navlink;
                    if ( (sectionId === 'home-content' && navTarget === 'home') ||
                         (sectionId === 'writings-content' && navTarget === 'writings') ||
                         (sectionId === 'about-content' && navTarget === 'about') ) {
                        navLink.classList.add('active');
                    }
                });
                if (sectionId === 'home-content') {
                    for (const elId in APP_CONFIG.ROTATING_TEXT_HOME) {
                        if (document.getElementById(elId) && typeof setupRotatingText === 'function') { 
                             setupRotatingText(elId, APP_CONFIG.ROTATING_TEXT_HOME[elId]);
                        }
                    }
                } else if (sectionId === 'about-content') {
                    if(typeof renderQuestionnaire === 'function') renderQuestionnaire(); 
                }
                window.scrollTo({ top: 0, behavior: 'auto' });
            } else { console.warn(`Target section #${sectionId} not found.`); }
        }

        function handleMainRouteChange() { 
            let mainSectionTarget = 'home-content';
            let articleDetailHash = '';
            const currentFullHash = window.location.hash;
            if (currentFullHash.startsWith('#post-')) {
                mainSectionTarget = 'writings-content'; articleDetailHash = currentFullHash;
            } else if (currentFullHash === '#writings') {
                mainSectionTarget = 'writings-content';
            } else if (currentFullHash === '#about') {
                mainSectionTarget = 'about-content';
            } else if (currentFullHash === '#home' || currentFullHash === '' || currentFullHash === '#') {
                mainSectionTarget = 'home-content'; 
                if (currentFullHash === '' || currentFullHash === '#') window.location.hash = 'home';
            } else { 
                const isExternalNav = Array.from($$('.desktop-nav a[target="_blank"], .mobile-menu a[target="_blank"]'))
                                        .some(link => link.href.endsWith(currentFullHash) || `#${link.dataset.navlink}` === currentFullHash);
                if (!isExternalNav) {
                     console.warn("Unknown hash, redirecting to #home:", currentFullHash);
                     window.location.hash = 'home'; return; 
                }
            }
            
            if (currentMainSection !== mainSectionTarget && (mainSectionTarget === 'home-content' || mainSectionTarget === 'writings-content' || mainSectionTarget === 'about-content')) {
                 showMainSection(mainSectionTarget);
            } else if (mainSectionTarget === 'writings-content' && articleDetailHash) { 
                 if(typeof handleWritingsArticleLogic === 'function') handleWritingsArticleLogic(articleDetailHash);
            }
            
            if (mainSectionTarget === 'writings-content') {
                if(typeof handleWritingsArticleLogic === 'function') handleWritingsArticleLogic(articleDetailHash); 
            } else if (mainSectionTarget === 'about-content') {
                document.title = APP_CONFIG.DEFAULT_TITLES.about;
            } else if (mainSectionTarget === 'home-content') { 
                document.title = APP_CONFIG.DEFAULT_TITLES.home; 
            }
        }

        function handleWritingsArticleLogic(articleHash) { 
            const defaultWritingsTitle = APP_CONFIG.DEFAULT_TITLES.writings;
            if (articleHash && articleHash.startsWith('#post-')) {
                const targetId = articleHash.substring(1);
                const targetArticle = $(`#${targetId}`);
                if (targetArticle) {
                    const titleElement = targetArticle.querySelector('h2');
                    const articleTitle = titleElement ? titleElement.textContent.trim() : "Article";
                    document.title = `${articleTitle} - Writings - Agraj Dubey`;
                    setTimeout(() => {
                        if (!isElementInViewport(targetArticle)) targetArticle.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        const heading = targetArticle.querySelector('h2');
                        if (heading) { heading.setAttribute('tabindex', '-1'); heading.focus({ preventScroll: true }); }
                    }, 100);
                } else { document.title = defaultWritingsTitle; console.warn(`Article with ID ${targetId} not found.`); }
            } else {
                document.title = defaultWritingsTitle;
                const grid = $('#writings-grid-container');
                if (grid && lastClickedReadMoreLink && document.body.contains(lastClickedReadMoreLink)) {
                     setTimeout(() => {
                        lastClickedReadMoreLink.focus({preventScroll: true});
                        if (!isElementInViewport(lastClickedReadMoreLink)) lastClickedReadMoreLink.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     }, 50);
                } else if (grid) {
                    setTimeout(() => {
                        grid.setAttribute('tabindex', '-1'); grid.focus({preventScroll: true});
                         if (!isElementInViewport(grid)) grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 50);
                }
                lastClickedReadMoreLink = null; 
            }
        }
        function isElementInViewport(el) { 
            if(!el) return false; const rect = el.getBoundingClientRect();
            return (rect.top >= 0 && rect.left >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && rect.right <= (window.innerWidth || document.documentElement.clientWidth));
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            revealSound = $('#revealSound'); 
            gameSpawnSoundEl = $('#gameSpawnSound');
            gameWinSoundEl = $('#gameWinSound');

            if (typeof p5 !== 'undefined') {
                new p5(p5Sketch); 
            } else {
                console.error("p5.js is not loaded!");
            }

            setupMobileMenu(); 
            setupScrollProgressBar();
            await loadAndRenderPosts(); 
            
            document.body.addEventListener('click', function(event) {
                const clickedLink = event.target.closest('a.glitch-button[href^="#post-"]');
                if (clickedLink) {
                    lastClickedReadMoreLink = clickedLink;
                }
            });

            setupStaticImageClick(); 
            handleMainRouteChange(); 
            window.addEventListener('hashchange', handleMainRouteChange); 
            
            const currentYearEl = $('#currentYear');
            if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();
            setupSecretGame();

             window.addEventListener('resize', () => {
                if (currentMainSection === 'home-content' && typeof setupHomePageRightColumnImages === 'function') {
                    clearTimeout(window.resizeHomeImagesTimeout);
                    window.resizeHomeImagesTimeout = setTimeout(setupHomePageRightColumnImages, 250);
                }
            });
        });
    </script>
</body>
</html>
