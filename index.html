<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>agraj - Portfolio</title>
    <link rel="icon" type="image/png" href="logo.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhai+2:wght@700&family=Inter:wght@400;500;600;700&family=Lato:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;500;700&family=Nunito:wght@400;700&family=Fuzzy+Bubbles:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

    <script>
        // Tailwind config from your previous correct version
        window.tailwind.config = { /* ... Tailwind config ... */ };
    </script>

    <style>
        /* --- All previous CSS rules from the last fully working visual version --- */
        /* Including :root, body, p5, site-container, site-navbar, site-content, page-section animations, typography, scrollbar, animated-images, CARD STYLES, FULL ARTICLE STYLES, POST-CONTENT-HTML STYLES, glitch button, progress bar, secret game, about section, media queries etc. */
        :root { /* ... */ } html { /* ... */ } body { /* ... */ } /* ... many many lines of CSS ... */
        @media (max-width: 768px) { /* ... */ }

        /* --- MODIFICATION FOR WRITINGS PAGE LOGIC --- */
        #writings-content #full-articles-container article {
            display: none; /* Default: hide all full articles */
             /* ... other article styles from before ... */
        }

        #writings-content #full-articles-container article:target {
            display: block !important; /* Show only the targeted article */
            opacity: 1 !important; 
            animation: fadeInArticle 0.6s ease-out forwards;
        }

        /* When a full article is targeted, hide the grid and its separator */
        #writings-content:has(#full-articles-container article:target) #writings-grid-container,
        #writings-content:has(#full-articles-container article:target) hr.separator.above-articles {
            display: none !important;
        }
        
        /* Ensure grid and separator are visible by default on #writings page (when no specific article is targeted) */
        #writings-content #writings-grid-container,
        #writings-content hr.separator.above-articles {
            display: grid; /* or block for hr */
        }
        #writings-content #writings-grid-container { /* ensure grid display properties are set */
             grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Or your specific grid setup */
        }
         #writings-content hr.separator.above-articles {
            display: block;
        }


    </style>
</head>
<body>
    <!-- HTML Structure (audio, p5, progress, overlay, site-container, etc.) -->
    <!-- This structure remains the same as your last fully working visual version -->
    <audio id="gameSpawnSound" src="spawn_sound.mp3" preload="auto"></audio>
    <!-- ... other audio ... -->

    <div id="p5-background-canvas"></div>
    <div class="progress-container"> <div class="progress-bar" id="progressBar"></div> </div> 
    <div class="bg-overlay"></div>

    <div class="site-container">
        <aside class="site-navbar">
            <!-- Navbar content from previous response -->
        </aside>

        <main class="site-content">
            <div id="page-container">
                <section id="home-content" class="page-section">
                    <!-- Home content -->
                </section>
                
                <section id="writings-content" class="page-section"> 
                    <div class="text-center mb-12 md:mb-16 pt-8"> 
                        <h1 class="text-4xl md:text-5xl font-bold font-outfit">My Writings</h1> 
                    </div> 
                    <section id="writings-grid-container" class="mb-12 md:mb-20 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8"></section> 
                    <hr class="separator above-articles"> <!-- Added a class to specifically target this hr -->
                    <section id="full-articles-container"> 
                        <div class="full-articles-content max-w-4xl mx-auto" id="full-articles-dynamic-content">
                            <!-- Full articles will be injected here by JS -->
                        </div> 
                    </section> 
                </section>
        
                <section id="about-content" class="page-section">
                    <!-- About content -->
                </section>
            </div>
        </main>
    </div>
    
    <div id="secret-game-modal">
        <!-- Secret game modal content -->
    </div>

    <script>
        // --- JAVASCRIPT FROM THE PREVIOUS "fix everything" RESPONSE ---
        // The one with the corrected renderQuestionnaire, setupRotatingText, 
        // showMainSection, and handleMainRouteChange.
        // NO significant JS changes are needed for THIS specific fix, as CSS :has and :target
        // will handle the primary logic of showing/hiding the grid vs. full article.
        // The existing JS routing should correctly activate the 'writings-content' section.

        const APP_CONFIG = { /* ... */ };
        let ALL_QUESTIONNAIRE_DATA = []; let visitorAnswers = {}; let questionsAnsweredCount = 0;
        let revealSound, gameSpawnSoundEl, gameWinSoundEl;
        function $(selector) { return document.querySelector(selector); }
        function $$(selector) { return document.querySelectorAll(selector); }
        let p5Blobs = []; const NUM_P5_BLOBS = 5; 
        function p5Sketch(p) { /* ... p5 code ... */ }
        let ALL_POSTS_DATA = [];
        function simpleMarkdownToHtml(md) { /* ... */ }
        function createPostPreviewCard(post, isForHome = false) { /* ... */ }
        function createFullArticleHtml(post) { /* ... */ }
        async function setupHomePageRightColumnImages() { /* ... */ }
        async function loadAndRenderPosts() { /* ... */ } // Existing logic is fine
        async function renderQuestionnaire() { /* ... */ }
        function setupQuestionnaireInteractions() { /* ... */ }
        function calculateAndShowMatch() { /* ... */ }
        let matterEngine, matterRender, matterRunner; /* ... Secret Game JS ... */
        function playSound(soundElement) { /* ... */ }
        function resetSecretGame() { /* ... */ }
        function updateGameInfoDisplay() { /* ... */ }
        function setupSecretGame() { /* ... */ }
        let rotatingTextInstances = {};
        function setupRotatingText(elementId, config) { /* ... */ }
        function setupScrollProgressBar() { /* ... */ }
        function setupWritingsCardHoverEffects() { /* ... */ }
        
        let currentMainSection = null; let lastClickedReadMoreLink = null; 
        
        // showMainSection remains largely the same. 
        // The CSS will handle showing/hiding grid vs full article within #writings-content
        function showMainSection(sectionId) { 
            const previouslyActiveSection = $('.page-section.active-section');
            if (previouslyActiveSection) { previouslyActiveSection.classList.remove('active-section'); previouslyActiveSection.style.display = 'none'; }
            const targetSection = $(`#${sectionId}`);
            if (targetSection) {
                targetSection.style.display = 'block'; targetSection.classList.add('active-section'); currentMainSection = sectionId;
                $$('.site-navbar .navbar-links a').forEach(navLink => { navLink.classList.remove('active'); const navTarget = navLink.dataset.navlink; if ( (sectionId === 'home-content' && navTarget === 'home') || (sectionId === 'writings-content' && navTarget === 'writings') || (sectionId === 'about-content' && navTarget === 'about') ) { navLink.classList.add('active'); } });
                if (sectionId === 'about-content' && typeof renderQuestionnaire === 'function') { renderQuestionnaire(); } 
                else if (sectionId === 'home-content' && typeof setupHomePageRightColumnImages === 'function') { 
                    const existingBubbles = $$('#animated-images-container .animated-post-image-bubble');
                    if (existingBubbles.length === 0 && ALL_POSTS_DATA.length > 0) { setupHomePageRightColumnImages(); }
                }
                // No special JS needed here to hide/show grid for #writings, CSS handles it.
                window.scrollTo({ top: 0, behavior: 'auto' });
            } else { console.warn(`Target section #${sectionId} not found.`); }
        }

        // handleMainRouteChange remains largely the same.
        // It just needs to ensure 'writings-content' is active when a post is targeted.
        function handleMainRouteChange() { 
            let mainSectionTarget = 'home-content'; let articleDetailHash = '';
            const currentFullHash = window.location.hash;

            if (currentFullHash.startsWith('#post-')) { 
                mainSectionTarget = 'writings-content'; // IMPORTANT: Individual posts are part of writings-content
                articleDetailHash = currentFullHash; 
            } 
            else if (currentFullHash === '#writings') { mainSectionTarget = 'writings-content'; } 
            else if (currentFullHash === '#about') { mainSectionTarget = 'about-content'; } 
            else if (currentFullHash === '#home' || currentFullHash === '' || currentFullHash === '#') {
                mainSectionTarget = 'home-content'; 
                if (currentFullHash === '' || currentFullHash === '#') {
                    if (window.history.replaceState) { window.history.replaceState(null, '', '#home'); } else { window.location.hash = '#home'; }
                }
            } else { 
                const isExternalNav = Array.from($$('.site-navbar .navbar-links a[target="_blank"]')).some(link => link.href.endsWith(currentFullHash) || `#${link.dataset.navlink}` === currentFullHash);
                if (!isExternalNav) { if (window.history.replaceState) { window.history.replaceState(null, '', '#home'); } else { window.location.hash = '#home'; } mainSectionTarget = 'home-content'; } 
                else { return; }
            }

            // If the main section needs to change OR if we are navigating within writings (grid to post, or post to post)
            if (currentMainSection !== mainSectionTarget || mainSectionTarget === 'writings-content') {
                 showMainSection(mainSectionTarget);
            }
            
            // Title and specific logic for focused article (scrolling, focus)
            if (mainSectionTarget === 'writings-content' && typeof handleWritingsArticleLogic === 'function') { 
                handleWritingsArticleLogic(articleDetailHash); // This handles scrolling to the article if one is targeted
            } 
            // Update document title (can be refined within handleWritingsArticleLogic too)
            if (mainSectionTarget === 'writings-content') {
                document.title = articleDetailHash && ALL_POSTS_DATA.find(p=>p.id === articleDetailHash.substring(1)) ? 
                                 (ALL_POSTS_DATA.find(p=>p.id === articleDetailHash.substring(1)).title + " - Writings") : 
                                 APP_CONFIG.DEFAULT_TITLES.writings;
            } else if (mainSectionTarget === 'about-content') { 
                document.title = APP_CONFIG.DEFAULT_TITLES.about; 
            } else if (mainSectionTarget === 'home-content') { 
                document.title = APP_CONFIG.DEFAULT_TITLES.home; 
            }
        }
        
        function handleWritingsArticleLogic(articleHash) { 
            // This function is now primarily for scrolling to the targeted article
            // The visibility of grid vs article is handled by CSS :target and :has
            if (articleHash && articleHash.startsWith('#post-')) {
                const targetId = articleHash.substring(1);
                const targetArticle = $(`#${targetId}`);
                if (targetArticle) {
                    // Ensure writings-content is active if it wasn't already
                    if (currentMainSection !== 'writings-content') {
                         showMainSection('writings-content');
                    }
                    setTimeout(() => { // Delay to allow CSS to apply display:block
                        if (!isElementInViewport(targetArticle)) {
                            targetArticle.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                        const heading = targetArticle.querySelector('h2');
                        if (heading) { 
                            heading.setAttribute('tabindex', '-1'); 
                            // Delay focus slightly more if scrollIntoView is happening
                            setTimeout(() => heading.focus({ preventScroll: true }), 150);
                        }
                    }, 100); 
                }
            } else {
                // If navigating to #writings (grid view), scroll to top of writings section or grid
                const writingsGrid = $('#writings-grid-container');
                if (writingsGrid && !isElementInViewport(writingsGrid)) {
                    // writingsGrid.scrollIntoView({behavior: 'smooth', block: 'start'}); // or scroll to top of page
                    window.scrollTo({ top: $('#writings-content').offsetTop || 0, behavior: 'smooth'});
                }
            }
        }
        function isElementInViewport(el) { /* ... */ }
        document.addEventListener('DOMContentLoaded', async () => { /* ... (ensure handleMainRouteChange is called) ... */ });

        // PASTE THE FULL JAVASCRIPT FROM THE PREVIOUS "COMPLETE" MESSAGE HERE
        // This is just a placeholder comment. The JS from the prior full HTML response is needed.
        // For brevity, I'm not repeating the entire JS block again if it was correct in the previous turn.
        // Make sure this is the version that had the corrected typewriter and routing.
         // --- Start of JS (from previous full working HTML) ---
        const APP_CONFIG_PREV = { /* ... */ };
        let ALL_QUESTIONNAIRE_DATA_PREV = []; let visitorAnswers_PREV = {}; let questionsAnsweredCount_PREV = 0;
        let revealSound_PREV, gameSpawnSoundEl_PREV, gameWinSoundEl_PREV;
        function $_PREV(selector) { return document.querySelector(selector); }
        function $$_PREV(selector) { return document.querySelectorAll(selector); }
        let p5Blobs_PREV = []; const NUM_P5_BLOBS_PREV = 5; 
        function p5Sketch_PREV(p) { /* ... p5 code ... */ }
        let ALL_POSTS_DATA_PREV = [];
        function simpleMarkdownToHtml_PREV(md) { /* ... */ }
        function createPostPreviewCard_PREV(post, isForHome = false) { /* ... */ }
        function createFullArticleHtml_PREV(post) { /* ... */ }
        async function setupHomePageRightColumnImages_PREV() { /* ... */ }
        async function loadAndRenderPosts_PREV() { /* ... */ }
        async function renderQuestionnaire_PREV() { /* ... (Ensure this has the console.logs and error handling) ... */ }
        function setupQuestionnaireInteractions_PREV() { /* ... */ }
        function calculateAndShowMatch_PREV() { /* ... */ }
        let matterEngine_PREV, matterRender_PREV, matterRunner_PREV; /* ... Secret Game JS ... */
        function playSound_PREV(soundElement) { /* ... */ }
        function resetSecretGame_PREV() { /* ... */ }
        function updateGameInfoDisplay_PREV() { /* ... */ }
        function setupSecretGame_PREV() { /* ... */ }
        let rotatingTextInstances_PREV = {};
        function setupRotatingText_PREV(elementId, config) { /* ... (direct start for navbar elements) ... */ }
        function setupScrollProgressBar_PREV() { /* ... */ }
        function setupWritingsCardHoverEffects_PREV() { /* ... */ }
        // currentMainSection and lastClickedReadMoreLink are already defined globally
        // function showMainSection_PREV(sectionId) { /* ... (with display:none/block) ... */ }
        // function handleMainRouteChange_PREV() { /* ... (with robust #home default and section re-evaluation) ... */ }
        // function handleWritingsArticleLogic_PREV(articleHash) { /* ... */ }
        // function isElementInViewport_PREV(el) { /* ... */ }
        document.addEventListener('DOMContentLoaded', async () => {
            revealSound = $_PREV('#revealSound'); gameSpawnSoundEl = $_PREV('#gameSpawnSound'); gameWinSoundEl = $_PREV('#gameWinSound');
            if (typeof p5 !== 'undefined') { new p5(p5Sketch_PREV); } else { console.error("p5.js is not loaded!"); }
            setupScrollProgressBar_PREV();
            await loadAndRenderPosts_PREV(); 
            for (const elId in APP_CONFIG_PREV.ROTATING_TEXT_HOME) { if (document.getElementById(elId) && typeof setupRotatingText_PREV === 'function') { setupRotatingText_PREV(elId, APP_CONFIG_PREV.ROTATING_TEXT_HOME[elId]); } }
            document.body.addEventListener('click', function(event) { const clickedLink = event.target.closest('a.glitch-button[href^="#post-"], a.read-more-link[href^="#post-"]'); if (clickedLink) { lastClickedReadMoreLink = clickedLink; } });
            handleMainRouteChange_PREV(); // Use the correctly scoped version
            window.addEventListener('hashchange', handleMainRouteChange_PREV); // Use the correctly scoped version
            setupSecretGame_PREV(); 
            window.addEventListener('resize', () => { if (currentMainSection === 'home-content' && typeof setupHomePageRightColumnImages_PREV === 'function') { clearTimeout(window.resizeHomeImagesTimeout); window.resizeHomeImagesTimeout = setTimeout(setupHomePageRightColumnImages_PREV, 250); } });
        });
         // --- End of JS ---


    </script>
</body>
</html>
